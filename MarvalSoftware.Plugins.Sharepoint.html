
<link href="https://fonts.googleapis.com/css2?family=Orbitron&display=swap" rel="stylesheet">
<script type="text/javascript" src="template.js"></script>
<template>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600;700&family=Nunito+Sans:wght@300;400;500;600;700&family=Source+Sans+Pro:wght@300;400;500;600;700&family=Lato:wght@300;400;500;700&family=Open+Sans:wght@300;400;500;600;700&family=Roboto:wght@300;400;500;700&family=Montserrat:wght@300;400;500;600;700&family=Outfit:wght@300;400;500;600;700&family=DM+Sans:wght@300;400;500;700&family=Plus+Jakarta+Sans:wght@300;400;500;600;700&family=Work+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /*        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }*/

        /*body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
            color: #333;
        }

        .body {
            max-width: 900px;*/
        /*            margin: 0 auto;*/
        /*background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 12px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            animation: fadeInUp 0.8s ease-out;*/

        .mini-create-btn {
            background-color: white !important;
        }

        .orbitron {
            font-family: 'Orbitron', sans-serif;
        }

        #sitesDropdown {
            width: 50%;
            height: 50px;
            margin: auto;
            border: 3px solid #32C0F0;
            border-radius: 10px;
            padding: 15px;
            display: block;
            font-family: 'Inter', sans-serif;
        }

        #successMessage {
            display: block;
            width: 45%;
            margin: auto;
            margin-top: 5px;
            border: 3px solid #E25F94;
            padding: 10px;
            height: 40px;
            border-radius: 15px;
            font-family: 'Inter', sans-serif;
        }

        #selectedFolder {
            display: block;
            width: 45%;
            margin: auto;
            margin-top: 5px;
            border: 3px solid #7867AD;
            padding: 10px;
            height: 40px;
            border-radius: 15px;
            font-family: 'Inter', sans-serif;
        }

        #content {
            background: #f5f5f5;
        }


        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .section-header {
            background: linear-gradient(135deg, #32C0F0, #7867AD);
            color: white;
            padding: 12px 20px;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
        }

            .section-header::before {
                content: '';
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
                animation: shimmer 2s infinite;
            }

        @keyframes shimmer {
            0% {
                left: -100%;
            }

            100% {
                left: 100%;
            }
        }

        .section {
            margin-bottom: 0;
        }

        .section-content {
            padding: 15px;
        }

        /* Notes Section */
        .note2-item {
            background: linear-gradient(135deg, rgba(50, 192, 240, 0.1), rgba(120, 103, 173, 0.1));
            border: 1px solid rgba(50, 192, 240, 0.2);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

            .note2-item::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                width: 3px;
                height: 100%;
                background: linear-gradient(180deg, #32C0F0, #7867AD);
                transition: width 0.3s ease;
            }

            .note2-item:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 15px rgba(50, 192, 240, 0.2);
                border-color: rgba(50, 192, 240, 0.4);
            }

                .note2-item:hover::before {
                    width: 100%;
                    opacity: 0.1;
                }

        /* Email Section */
        .email-row {
            background: linear-gradient(135deg, rgba(226, 95, 148, 0.1), rgba(241, 93, 93, 0.1));
            border: 1px solid rgba(226, 95, 148, 0.2);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            display: grid;
            grid-template-columns: auto 130px 200px 1fr;
            gap: 15px;
            align-items: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

            .email-row::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                width: 3px;
                height: 100%;
                background: linear-gradient(180deg, #E25F94, #F15D5D);
                transition: width 0.3s ease;
            }

            .email-row:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 15px rgba(226, 95, 148, 0.2);
                border-color: rgba(226, 95, 148, 0.4);
            }

                .email-row:hover::before {
                    width: 100%;
                    opacity: 0.1;
                }

        .email-date {
            font-weight: 600;
            color: #E25F94;
            font-size: 12px;
        }

        .email-address {
            font-weight: 500;
            color: #666;
            font-size: 12px;
        }

        .email-subject {
            color: #333;
            font-weight: 500;
            font-size: 13px;
        }

        /* Attachment Section */
        .attachment-item {
            background: linear-gradient(135deg, rgba(120, 103, 173, 0.1), rgba(226, 95, 148, 0.1));
            border: 1px solid rgba(120, 103, 173, 0.2);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

            .attachment-item::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                width: 3px;
                height: 100%;
                background: linear-gradient(180deg, #7867AD, #E25F94);
                transition: width 0.3s ease;
            }

            .attachment-item:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 15px rgba(120, 103, 173, 0.2);
                border-color: rgba(120, 103, 173, 0.4);
            }

                .attachment-item:hover::before {
                    width: 100%;
                    opacity: 0.1;
                }

        /* Checkboxes */
        input[type="checkbox"] {
            appearance: none;
            width: 16px;
            height: 16px;
            border: 2px solid #ddd;
            border-radius: 4px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 10px;
        }

            input[type="checkbox"]:checked {
                background: linear-gradient(135deg, #32C0F0, #7867AD);
                border-color: #32C0F0;
            }

                input[type="checkbox"]:checked::after {
                    content: 'âœ“';
                    position: absolute;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    color: white;
                    font-weight: bold;
                    font-size: 10px;
                }

        /* Labels */
        label {
            font-weight: 600;
            color: #333;
            cursor: pointer;
            transition: color 0.3s ease;
            font-size: 14px;
        }

            label:hover {
                color: #32C0F0;
            }

        .note2-summary {
            margin-left: 26px;
            color: #666;
            font-size: 12px;
            margin-top: 6px;
            font-style: italic;
        }

        #combineNotesBox {
            height: 20px;
            background: linear-gradient(135deg, #32C0F0, #7867AD, #E25F94, #F15D5D);
            background-size: 300% 300%;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 6px 12px rgba(50, 192, 240, 0.3);
            position: relative;
            overflow: hidden;
            margin: 15px;
            animation: gradientShift 3s ease infinite;
        }
        /* Upload Button */
        #uploadButtonTwo {
            height: 40px;
            background: linear-gradient(135deg, #32C0F0, #7867AD, #E25F94, #F15D5D);
            background-size: 300% 300%;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 6px 12px rgba(50, 192, 240, 0.3);
            position: relative;
            overflow: hidden;
            margin: 15px;
            animation: gradientShift 3s ease infinite;
        }
        #saveButton {
            height: 40px;
            background: linear-gradient(135deg, #32C0F0, #7867AD, #E25F94, #F15D5D);
            background-size: 300% 300%;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 6px 12px rgba(50, 192, 240, 0.3);
            position: relative;
            overflow: hidden;
            margin: 15px;
            animation: gradientShift 3s ease infinite;
        }

        @keyframes gradientShift {
            0%, 100% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }
        }

        #uploadButtonTwo:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px rgba(50, 192, 240, 0.4);
            animation-duration: 1s;
        }

        #uploadButtonTwo:active {
            transform: translateY(0);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .body {
                margin: 5px;
                border-radius: 10px;
            }

            .section-content {
                padding: 12px;
            }

            .email-row {
                grid-template-columns: auto 1fr;
                gap: 8px;
            }

            .email-date,
            .email-address {
                grid-column: 2;
            }

            .email-subject {
                grid-column: 2;
                margin-top: 3px;
            }
        }

        /* Section separators */
        .section + .section {
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* Hover effects for sections */
        .section {
            transition: all 0.3s ease;
        }

            .section:hover {
                background: rgba(255, 255, 255, 0.05);
            }
        /*        #groupsDropdown {
                    font-weight: normal;
                }*/
        /*.container {
            max-width: 1024px;
            margin: 0 auto;
        }
        .note-item {
            padding: 8px;
            border-bottom: 1px solid #ccc;
            font-family: Arial, sans-serif;
        }*/
        /*        #attachmentsDiv{
            display:flex;
        }*/
        #itemsDiv {
            margin-top: 20px;
            display: block; /* or 'flex' if needed for layout */
            width: auto;
            height: auto;
            max-width: 100%;
            max-height: 100%;
            overflow: auto; /* adds scrollbars if content overflows */
            box-sizing: border-box; /* ensures padding doesn't overflow container */
            margin: 15px;
            padding: 20px;
        }


        /*#notesDiv,
        #attachmentsDiv, #emailsDiv {
            flex: 1;*/ /* Make them grow equally */
        /*min-width: 0;*/ /* Prevent overflow if needed */
        /*border: 1px solid #ccc;*/ /* Optional: visual separation */
        /*padding: 8px;
            box-sizing: border-box;
            border-radius:25px;
            margin:10px;
        }

        .note-item input[type="checkbox"] {
            margin-right: 8px;
        }*/

        .folder-tree {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            overflow: hidden;
        }

        .folder-icon.selected,
        .folder-icon.selected path {
            fill: #22c55e !important;
        }

        .header {
            border-bottom: 1px solid #e5e7eb;
            padding: 16px !important;
        }

            .header h2 {
                font-size: 18px;
                font-weight: 600;
                color: #374151;
                margin-bottom: 4px;
            }

            .header p {
                font-size: 14px;
                color: #6b7280 !important;
            }

        .tree-content {
            height: 300px;
            padding: 16px;
            overflow: auto;
        }

        .tree-item {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 2px 2px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
            user-select: none;
        }

            .tree-item:hover {
                background-color: #f9fafb;
            }

            .tree-item.hovered {
                background-color: #eff6ff;
            }

                .tree-item.hovered:hover {
                    background-color: #dbeafe;
                }

        .tree-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .expand-button2 {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            border: none;
            background: none;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.2s;
            padding: 0;
        }

            .expand-button2:hover {
                background-color: #e5e7eb;
            }

        .chevron {
            width: 16px !important;
            height: 16px !important;
            fill: #6b7280 !important;
            transition: transform 0.2s !important;
        }

        /*        .mini-create-btn {
            width: 16px !important;
            height: 16px !important;
            fill: #6b7280 !important;
            transition: transform 0.2s !important;
        }*/

        .plus-icon {
            width: 12px !important;
            height: 12px !important;
            fill: #6b7280 !important;
            transition: transform 0.2s !important;
            color: gray;
        }

        .chevron.expanded {
            transform: rotate(90deg);
        }

        .folder-icon {
            width: 20px;
            height: 20px;
            fill: #2563eb;
        }

        .folder-name {
            font-size: 14px;
            color: #374151;
            font-weight: 500;
            flex: 1;
        }

        .item-count {
            font-size: 12px !important;
            color: #6b7280 !important;
            background-color: #f3f4f6 !important;
            padding: 2px 8px !important;
            border-radius: 12px !important;
            margin-left: 8px !important;
        }

        .last-modified {
            font-size: 12px;
            color: #9ca3af;
            margin-left: 8px;
        }

        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid #e5e7eb;
            border-top: 2px solid #2563eb;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .children {
            margin-left: 20px;
        }

        .notes2 {
            margin-top: 24px;
            padding: 16px;
            background-color: #f9fafb;
            border-radius: 8px;
        }

            .notes2 h3 {
                font-weight: 500;
                color: #374151;
                margin-bottom: 8px;
            }

            .notes2 ul {
                list-style: none;
                font-size: 14px;
                color: #6b7280 !important;
            }

            .notes2 li {
                margin-bottom: 4px;
                padding-left: 8px;
            }

                .notes2 li::before {
                    content: "â€¢ ";
                    margin-right: 4px;
                }

            .notes2 code {
                background-color: #f3f4f6;
                padding: 2px 4px;
                border-radius: 4px;
                font-family: 'Courier New', monospace;
            }



        .content {
            border-radius: 10px;
            font-family: 'Inter', 'Open Sans', sans-serif;
            font-weight: bold;
            /*            height:500px !important;*/
        }


        .messageButton {
            background-color: #8c9097;
            font-weight: normal;
            cursor: pointer;
        }

        #uploadFile {
            cursor: pointer;
        }

        #createFolder {
            cursor: pointer;
        }

        .LinkedProjectsHeader {
            /* background: linear-gradient(to bottom right,#cbd6e2,#cbd6e2) !important;  */
            color: #00314a !important;
            font-size: 12px !important;
            font-family: 'Inter', 'Open Sans', sans-serif;
        }

            .LinkedProjectsHeader h1 {
                /* background: linear-gradient(to bottom right,#cbd6e2,#cbd6e2) !important;  */
                color: #00314a !important;
                font-size: 12px !important;
                font-family: 'Inter', 'Open Sans', sans-serif;
            }

        .headerColourChange {
            background: linear-gradient(to bottom right, #cbd6e2, #cbd6e2) !important;
            color: #00314a !important;
            font-size: 18px !important;
            font-family: 'Inter', 'Open Sans', sans-serif;
            border-radius: 10px;
        }



        #message {
            vertical-align: top;
            /*            height: 100px;*/
            width: 600px;
        }

        marvalsoftware-plugins-sharepoint {
            /*            display: block;*/
            height: 200px;
        }

            /*            marvalsoftware-plugins-sharepoint > .config-area {
                        height: 100px;
                        padding: 0px 10px 10px 10px;
                        box-shadow: 0 1px 0 0 #ebe8e4;
                    }

                        marvalsoftware-plugins-sharepoint > .config-area > div {
                            padding: 10px 0 0 0;
                        }
        */
            marvalsoftware-plugins-sharepoint > .message-area {
                /*                display: block;*/
                height: 100px;
                padding: 10px;
                box-shadow: 0 1px 0 0 #ebe8e4;
            }

                marvalsoftware-plugins-sharepoint > .message-area > .cards {
                    height:;
                    overflow-y: auto;
                    padding: 10px;
                    box-shadow: 0 1px 0 0 #ebe8e4;
                }

                    marvalsoftware-plugins-sharepoint > .message-area > .cards .card {
                        background-color: #fff;
                        padding: 1.5rem;
                        margin-bottom: 0.5rem;
                        border: 1px solid #ebe8e4;
                        border-radius: 4px;
                        box-shadow: 0 1px 1px 0 #ebe8e4;
                    }

                        marvalsoftware-plugins-sharepoint > .message-area > .cards .card .timestamp {
                            font-size: 0.75rem;
                            font-weight: 500;
                            color: #666;
                            width: 10%;
                        }

                        marvalsoftware-plugins-sharepoint > .message-area > .cards .card .tooltip {
                            position: relative;
                            /*                            display: inline-block;*/
                        }

                            marvalsoftware-plugins-sharepoint > .message-area > .cards .card .tooltip .tooltiptext {
                                visibility: hidden;
                                width: 120px;
                                background-color: #555;
                                /*                                color: #fff;*/
                                text-align: center;
                                border-radius: 6px;
                                padding: 5px 0;
                                position: absolute;
                                z-index: 1;
                                bottom: 125%;
                                left: 50%;
                                margin-left: -60px;
                                opacity: 0;
                                transition: opacity 0.3s;
                            }

                                marvalsoftware-plugins-sharepoint > .message-area > .cards .card .tooltip .tooltiptext::after {
                                    content: "";
                                    position: absolute;
                                    top: 100%;
                                    left: 50%;
                                    margin-left: -5px;
                                    border-width: 5px;
                                    border-style: solid;
                                    border-color: #555 transparent transparent transparent;
                                }

                            marvalsoftware-plugins-sharepoint > .message-area > .cards .card .tooltip:hover .tooltiptext {
                                visibility: visible;
                                opacity: 1;
                            }

                        marvalsoftware-plugins-sharepoint > .message-area > .cards .card .status {
                            margin-top: 0.75rem;
                            font-size: 1rem;
                            font-weight: 600;
                        }

                        marvalsoftware-plugins-sharepoint > .message-area > .cards .card .message {
                            line-height: 22px;
                            margin-right: 6rem;
                            color: #666;
                            font-size: 0.875rem;
                            white-space: pre-line;
                        }

            marvalsoftware-plugins-sharepoint > .update-area {
                height: 20%;
                padding: 10px 10px 0 10px;
            }

                marvalsoftware-plugins-sharepoint > .update-area textarea {
                    width: 100%;
                    height: 75%;
                    box-sizing: border-box;
                    -moz-box-sizing: border-box;
                    -webkit-box-sizing: border-box;
                    resize: none;
                }

                marvalsoftware-plugins-sharepoint > .update-area .action-buttons {
                    float: right;
                    padding-top: 10px;
                }

                    marvalsoftware-plugins-sharepoint > .update-area .action-buttons button {
                        box-sizing: border-box;
                        border: 1px solid #ccc;
                        border-radius: 2px;
                        background-color: #6697EA; /*changing colour from green to blue*/
                        cursor: pointer; /*changing to pointer when cursor is over it*/
                    }

                marvalsoftware-plugins-sharepoint > .update-area label,
                marvalsoftware-plugins-sharepoint > .message-area label,
                marvalsoftware-plugins-sharepoint > .config-area > div label {
                    font-size: 1rem;
                    font-weight: 600;
                    /*                    display: inline-block;*/
                    width: 50px;
                    padding-bottom: 5px;
                }

        .headerColourChange {
            background: linear-gradient(to bottom right, #cbd6e2, #cbd6e2) !important;
            color: #00314a !important;
            font-size: 18px !important;
            font-family: 'Inter', 'Open Sans', sans-serif;
        }

        marvalsoftware-plugins-sharepoint > .message-area label {
            width: 100px !important;
        }

        marvalsoftware-plugins-sharepoint > .message-area > .header {
            align-items: center
        }

            marvalsoftware-plugins-sharepoint > .message-area > .header a img {
                position: relative;
                top: 4px;
            }
    </style>
    <div class="config-area">


    </div>

    <!--<div id="folderTreeWrapper">--> <!--folder tree stuff goes here-->
    <!--<div class="container">
        <div class="folder-tree">
            <div class="header">
                <h2>SharePoint Folders</h2>
                <p>Browse and explore your folder structure</p>
            </div>
            <div class="tree-content" id="treeContent">-->
    <!-- Tree items will be generated here -->
    <!--</div>
        </div>

        <div class="notes">
            <h3>API Integration Notes:</h3>
            <ul>
                <li>Replace the mock <code>fetchChildren</code> function with actual Microsoft Graph API calls</li>
                <li>Add proper error handling and authentication</li>
                <li>Consider implementing virtual scrolling for large folder structures</li>
                <li>Add context menus for folder operations (create, rename, delete, etc.)</li>
                <li>Implement search functionality across the folder structure</li>
            </ul>
        </div>
    </div>-->
    <!--</div>-->
    <div class="container" id="treeContainer">
        <div class="folder-tree">
            <div class="header">
                <h2>SharePoint Folders</h2>
                <p>Browse and explore your folder structure</p>
            </div>
            <div class="tree-content" id="treeContent" display="none">
                <!-- Tree items will be generated here -->
            </div>
        </div>

    </div>

    <select id="sitesDropdown"><option>Loading!</option></select>
    <!--<select id="foldersDropdown"><option>Still loading!</option></select>-->
    <div id="successMessage">Success Message</div>


    <div id="selectedFolder">Current Folder Path</div>
    <!--<div id="attachmentsDiv" style="display: none;"></div>-->
    <!--<input type="checkbox" id="createSubfolder"/>-->
    <button id="saveButton">Save Path</button>
    <button id="AttachmentsPage">Attachments Page</button>


</template>
<template class="cardTemplate">
    <div class="card">
        <div class="timestamp tooltip">
            <span class="tooltiptext"></span>
        </div>
        <div class="status"></div>
        <div class="message"></div>
    </div>
</template>
<template class="errorTemplate">
    <style>
        .marvalsoftware-sharepoint-errors h3,
        .marvalsoftware-sharepoint-errors h4 {
            padding: 8px 0 8px 0;
        }

        .sharepointConfig > li {
            display: none;
        }
    </style>
    <div class="marvalsoftware-sharepoint-errors">
        <div class="title">
            <h3>Ensure all configuration settings are correct.</h3>
        </div>
        <div>
            <ul class="sharepointConfig">
                <li id="userAPIKey"> Organisation API Key </li>
            </ul>
            <h4></h4>
        </div>
    </div>
</template>
<template class="miscellaneousErrorsTemplate">
    <style>
        .marvalsoftware-sharepoint-errors h3,
        .marvalsoftware-sharepoint-errors h4 {
            padding: 8px 0 8px 0;
        }
    </style>
    <div class="marvalsoftware-sharepoint-errors">
        <div class="title">
            <h3>Error loading Sharepoint.</h3>
        </div>
        <div>
            <label></label>
        </div>
    </div>
</template>
<link href="https://fonts.googleapis.com/css2?family=Orbitron&display=swap" rel="stylesheet">
<script type="text/javascript" src="msal-browser.min.js"></script>
<script>
    (function () {

        var MarvalSoftware = window.top.MarvalSoftware;
        var $ = window.top.$;
        var Sharepoint = null;
        let folderPaths = {}; //empty hashmap, we will have <folderid, path> so <string,string>
        var allPaths = new Map();


        let mockApiData = {
            value: [
                {
                    id: '1',
                    name: 'Documents',
                    folder: { childCount: 3 },
                    createdDateTime: '2024-01-15T10:30:00Z',
                    lastModifiedDateTime: '2024-01-20T14:22:00Z'
                },
                {
                    id: '2',
                    name: 'Images',
                    folder: { childCount: 5 },
                    createdDateTime: '2024-01-10T09:15:00Z',
                    lastModifiedDateTime: '2024-01-18T16:45:00Z'
                },
                {
                    id: '3',
                    name: 'Projects',
                    folder: { childCount: 2 },
                    createdDateTime: '2024-01-12T11:20:00Z',
                    lastModifiedDateTime: '2024-01-12T11:20:00Z'
                },
                {
                    id: '4',
                    name: 'Archives',
                    folder: { childCount: 1 },
                    createdDateTime: '2024-01-14T13:45:00Z',
                    lastModifiedDateTime: '2024-01-16T10:30:00Z'
                }
            ]
        };

        let mockSubfolderData = {
            '1': {
                value: [
                    {
                        id: '1-1',
                        name: 'Contracts',
                        folder: { childCount: 2 },
                        createdDateTime: '2024-01-15T10:30:00Z',
                        lastModifiedDateTime: '2024-01-20T14:22:00Z'
                    },
                    {
                        id: '1-2',
                        name: 'Legal',
                        folder: { childCount: 1 },
                        createdDateTime: '2024-01-16T09:15:00Z',
                        lastModifiedDateTime: '2024-01-16T09:15:00Z'
                    },
                    {
                        id: '1-3',
                        name: 'Templates',
                        folder: { childCount: 0 },
                        createdDateTime: '2024-01-17T14:20:00Z',
                        lastModifiedDateTime: '2024-01-17T14:20:00Z'
                    }
                ]
            },
            '2': {
                value: [
                    {
                        id: '2-1',
                        name: 'Marketing',
                        folder: { childCount: 3 },
                        createdDateTime: '2024-01-10T09:15:00Z',
                        lastModifiedDateTime: '2024-01-10T09:15:00Z'
                    },
                    {
                        id: '2-2',
                        name: 'Product',
                        folder: { childCount: 2 },
                        createdDateTime: '2024-01-11T15:30:00Z',
                        lastModifiedDateTime: '2024-01-11T15:30:00Z'
                    },
                    {
                        id: '2-3',
                        name: 'Screenshots',
                        folder: { childCount: 0 },
                        createdDateTime: '2024-01-12T11:45:00Z',
                        lastModifiedDateTime: '2024-01-12T11:45:00Z'
                    }
                ]
            }
        };

        // Global state
        let folderData = {};
        let expandedFolders = new Set();
        let loadingFolders = new Set();
        const icons = {
            chevronRight: `<svg class="chevron" viewBox="0 0 16 16">
    <path d="M6.22 3.22a.75.75 0 0 1 1.06 0l4.25 4.25a.75.75 0 0 1 0 1.06l-4.25 4.25a.75.75 0 0 1-1.06-1.06L9.94 8 6.22 4.28a.75.75 0 0 1 0-1.06Z"/>
</svg>`,
            folderClosed: `<svg class="folder-icon" viewBox="0 0 20 20">
    <path d="M2 6a2 2 0 0 1 2-2h5l2 2h5a2 2 0 0 1 2 2v6a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6Z"/>
</svg>`,
            folderOpen: `<svg class="folder-icon" viewBox="0 0 20 20">
    <path d="M2 6a2 2 0 0 1 2-2h5l2 2h5a2 2 0 0 1 2 2v6a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6Z" fill-opacity="0.7"/>
    <path d="M2 8h16v8a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V8Z"/>
</svg>`,
            spinner: `<div class="spinner"></div>`,
            plus: `<svg class="plus-icon" viewBox="0 0 16 16">
    <path d="M8 1v14M1 8h14" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/>
</svg>`

        };
        //window.toggleFolder = toggleFolder;
        MarvalSoftware.Plugins.define("marvalsoftware-plugins-sharepoint",
            {
                _element: null,
                _body: null,
                _refreshLink: null,
                _refreshElement: null,
                _cards: null,
                _card: null,
                _status: null,
                _message: null,
                _pages: null,
                _incidents: null,
                _createElement: null,
                _requestNumber: null,
                _requestID: null,
                _requestDescription: null,
                _contactEmail: null,
                _fullPluginPathHandler: null,
                _requestActionMessageID: null,
                _rowIndex: null,
                _attachmentName: null,
                _microsoftToken: null,
                _currentPath: null,
                _prevId: null,
                _currentSelectedFolderId: null,
                _requestAcronym: null,
                _requestNumber: null,
                _customAttribute: null,
                _SuggestDirectoryName: null,
                _createFolderOption: null,
                _AutomateSubfolderCreation: null,
                _isLoginInProgress: false,
                _loginPromise: null,
                // Sharepoint: null,




                init: function () {

                    var requestNumber = $("#ctl00_cph_requestNumber").val();
                    var requestAcronym = $("#ctl00_cph_requestTypeAcronym").text();
                    this._requestAcronym = requestAcronym;
                    this._requestNumber = requestNumber;

                    //const customAttributeUrl = _fullPluginPathHandler + "?endpoint=CustomAttribute"; // adjust as needed

                    //const customAttribute = await(await fetch(customAttributeUrl)).text();
                    console.log("requst number from page is ", requestNumber, "with request acronym ", requestAcronym);

                    Sharepoint = this;
                    Sharepoint._currentPath = "";
                    //window.Sharepoint = this;

                    this._sendInProgress = false; //we will use later to keep track of if we are sending a request
                    var HeaderText = $('#ctl00_ctl00_cph_entityHeaderText').text();
                    var currentUrl = window.top.location.href;
                    var currentHost = window.top.location.host;
                    _fullPluginPathHandler = "https://" + currentHost + Sharepoint._getPluginPath() + "handler/APIHandler.ashx";
                    //checkRequestActionMessageExists(); //should be /handler/APIHandler/ashx
                    //let hostString = await(await fetch(Sharepoint._getPluginPath() + "Handler.ashx?endpoint=ChatbotHostOverride")).text()
                    //let tenantId = await(await fetch(Sharepoint._getPluginPath() + "Handler.ashx?endpoint=TenantID")).text()
                    //let secret = await(await fetch(Sharepoint._getPluginPath() + "Handler.ashx?endpoint=SecretKey")).text()

                    if (currentUrl.includes("Plugin.aspx") && HeaderText == 'MarvalSoftware.Plugins.Sharepoint') { //we are on plugins page
                        checkRequestActionMessageExists();
                        let globalSettingsDiv = $("#ctl00_ctl00_cph_maintenance_globalSettingsFieldSet");
                        let hiddenBox = $("#ctl00_ctl00_cph_maintenance_globalSettingsRepeater_ctl05_value");
                        hiddenBox.hide()
                        console.log("should be hidden but we can accesss its val ", hiddenBox.val());

                        let nameDropdown = document.createElement("select");
                        nameDropdown.id = "createFolderOptionSelect";


                        const options = [
                            { text: "None", value: "None" },
                            { text: "MSM and Custom Attribute", value: "MSMAndCustomAttribute" },
                            { text: "MSM", value: "MSM" },
                            { text: "Custom Attribute", value: "CustomAttribute" }
                        ];

                        options.forEach((opt, idx) => { //builkd them
                            const option = document.createElement("option");
                            option.text = opt.text;
                            option.value = opt.value;
                            if (idx === 0) option.selected = true;
                            nameDropdown.appendChild(option);
                        });

                        let storedValue = hiddenBox.val();
                        if (storedValue) { //if stored value exists then 
                            nameDropdown.value = storedValue; // selects the matching option if it exists
                        } else {
                            nameDropdown.value = "None"; // fallback/default
                        }


                        // Create the wrapper span
                        let formSpan = document.createElement("span");
                        formSpan.className = "formSpan";
                        $("label.largeLabel").filter(function () {
                            return $(this).text().trim() === "@@createFolderOption";
                        }).hide(); // or .css("display", "none")

                        // Create the labels
                        let keyLabel = document.createElement("label");
                        keyLabel.id = "ctl00_ctl00_cph_maintenance_globalSettingsRepeater_ctl06_key";
                        keyLabel.className = "globalSettingKey";
                        keyLabel.textContent = "@@EnforceReferences";

                        let displayLabel = document.createElement("label");
                        displayLabel.className = "largeLabel";
                        displayLabel.textContent = "@@EnforceReferences";

                        // Create the <select> - initially hidden input for ASP.NET compatibility
                        let hiddenInput = document.createElement("input");
                        hiddenInput.type = "hidden";
                        hiddenInput.id = "ctl00_ctl00_cph_maintenance_globalSettingsRepeater_ctl06_value";
                        hiddenInput.name = "ctl00$ctl00$cph$maintenance$globalSettingsRepeater$ctl06$value";
                        hiddenInput.value = "None"; // Default value





                        // Update hidden input when dropdown changes
                        nameDropdown.addEventListener("change", function () {
                            hiddenInput.value = this.value;
                        });

                        // Create the apply button
                        let applyButton = document.createElement("button");
                        applyButton.id = "applyButton";
                        applyButton.type = "button"; // Prevent form submission
                        applyButton.textContent = "Apply";

                        applyButton.addEventListener("click", function () {
                            let selectedValue = nameDropdown.value;

                            console.log("selected value is ", selectedValue);
                            hiddenBox.text(selectedValue);
                            hiddenBox.val(selectedValue);

                            // Update the hidden input with selected value
                            hiddenInput.value = selectedValue;

                            let fakeButton = $("#ctl00_ctl00_cph_apply_fakeApplyButton");
                            fakeButton.click();

                            // Create visible text input
                            let textInput = document.createElement("input");
                            textInput.type = "text";
                            textInput.className = "text";
                            textInput.value = selectedValue;
                            textInput.addEventListener("input", function () {
                                hiddenInput.value = this.value; // Keep hidden input synced
                            });

                            // Replace dropdown with text input
                            nameDropdown.replaceWith(textInput);

                            // Change apply button to "Edit"
                            applyButton.textContent = "Edit";
                            applyButton.onclick = function () {
                                // Convert back into dropdown
                                let newDropdown = nameDropdown.cloneNode(true);

                                // Set dropdown to current value
                                for (let option of newDropdown.options) {
                                    if (option.value === hiddenInput.value) {
                                        option.selected = true;
                                        break;
                                    }
                                }

                                // Re-add change listener
                                newDropdown.addEventListener("change", function () {
                                    hiddenInput.value = this.value;
                                });

                                textInput.replaceWith(newDropdown);

                                // Restore the original apply functionality
                                applyButton.textContent = "Apply";
                                nameDropdown = newDropdown;

                                // Restore original click handler
                                applyButton.onclick = arguments.callee;
                            };
                        });

                        // Add everything to the span
                        formSpan.appendChild(keyLabel);
                        formSpan.appendChild(displayLabel);
                        formSpan.appendChild(nameDropdown);
                        formSpan.appendChild(hiddenInput); // Add hidden input to form
                        formSpan.appendChild(applyButton);

                        // Append to the container - make sure it's inside the form
                        globalSettingsDiv.append(formSpan);


                        function OpenInstallRequestRuleDialog() {
                            event.preventDefault();
                            $('#setupActionRuleModal').fadeIn(200);


                            var getWorkflowStatuses = fetch(_fullPluginPathHandler, {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({
                                    action: "getWorkflowStatuses"
                                })
                            });
                            getWorkflowStatuses.then(async workflowStatuses => {
                                var jsonWorkflowStatusData = await workflowStatuses.json();
                                // console.log("Have workflows statuses as ", jsonWorkflowStatusData);
                                var $select = $('#workflowStatusDropdown');
                                $select.empty();
                                $select.append('<option value="">-- Select a Workflow Status --</option>');
                                jsonWorkflowStatusData.forEach(element => {
                                    $select.append($('<option>').val(element.Identifier).text(element.Name));
                                })
                            })
                            var getWorkflows = fetch(_fullPluginPathHandler, {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({
                                    action: "getWorkflows"
                                })
                            });
                            getWorkflows.then(async workflows => {
                                var jsonworkflowData = await workflows.json();
                                //    console.log("Have workflow data as ", jsonworkflowData);
                                var $select = $('#workflowDropdown');
                                $select.empty();
                                $select.append('<option value="">-- Select a Workflow --</option>');
                                jsonworkflowData.forEach(element => {
                                    $select.append($('<option>').val(element.Identifier).text(element.Name));
                                    //     console.log("Have element ", element);
                                })
                            })
                        }

                        $('head').append(`
                        <style>
                        /* âœ… Steps */
.modal-steps {
  margin: 0;
  padding-left: 1.25rem;
  list-style: disc;
  color: #073f5c;
}
.modal-steps li {
  margin-bottom: .9rem;
}
.modal-steps a {
  color: #1696B7;
  text-decoration: underline;
}
.modal-steps a:hover {
  text-decoration: none;
}


.close {
  position: absolute;
  top: .75rem;
  right: .75rem;
  width: 32px;
  height: 32px;
  border: none;
  background: #1696B7;
  //color: #fff;
  font-size: 1.25rem;
  line-height: 1;
  border-radius: 50%;
  cursor: pointer;
  transition: background .2s ease;
}
.close:hover { background: #073f5c; }

/* ðŸ“ˆ Subtle pop-in */
@keyframes pop {
  0%   { transform: scale(.85); opacity: 0; }
  100% { transform: scale(1);   opacity: 1; }
}


.modal-content {
  display: flex;
  flex-direction: column;
  align-items: center;    /* horizontally center all direct children */
  text-align: center;      /* center text inside headings, list items, etc. */
  padding: 1.5rem;         /* optional, for a bit of breathing room */
}

.modal-content .modal-steps {
  padding: 0;
  list-style-position: inside; /* keep the bullets but centered */
  margin: 1rem 0;
}

.modal-content input,
.modal-content .hrefButton,
.modal-content .close {
  /* make sure buttons/inputs shrink to their contents */
  display: inline-block;
  margin: 0.5rem 0;
}
                        .headerColourChange {
    background: linear-gradient(to bottom right, #cbd6e2, #cbd6e2) !important;
    color: #00314a !important;
    font-size: 18px !important;
    font-family: 'Inter', 'Open Sans', sans-serif;
}
                        .modalBox {
  position: fixed;
  inset: 0;
  z-index: 9999;
  display: none;                 /* toggle with JS */
  place-items: center;
  background: rgba(7, 63, 92, .60);   /* #073f5c with 60Â % opacity */
  backdrop-filter: blur(2px);
}

/* ðŸ—‚ï¸  Content card -------------------------------------------------------- */
.modal-content {
  width: min(600px, 90%);

  border-radius: 12px;
  box-shadow: 0 8px 24px rgba(0,0,0,.25);
  padding: 2.5rem 2.25rem;
  animation: pop .35s ease;
  position: relative;
  font-family: "Segoe UI", Roboto, sans-serif;
}

/* ðŸŽ€ Header */
.modal-content h2 {
  margin: 0 0 1.25rem;
  font-size: 1.5rem;
  line-height: 1.2;
  color: #073f5c;
}
.modal-content h2 span {
  border-bottom: 3px solid #1696B7;
  padding-bottom: .25rem;
}
                            </style>`);
                        $('#ctl00_ctl00_cph_maintenance_pluginDetailsFieldSet').before(`<button class="hrefButton" id="requestActionMessageInstall">
  Install Request Action Message
</button>
<div id="requestActionMessageResponse"> </div>
<br>
<br>
<button class="hrefButton" id="actionRuleInstall">
  Open Request Action Rule Dialogue
</button>
<br>
<br>
<div id="setupActionRuleModal" class="modalBox">
  <div class="modal-content">
    <button class="close" title="Close">&times;</button>
<br>
    <h2><span>Install the Request Action Rule</span></h2>
    <br>
  <p>This section rule is used to determine the criteria for running the request action rule to create a new Sharepoint User.</p>
  <p>You can modify this later directly in the request action rule.</p>
  <br>
 <div class="form-group">
      <label for="workflowDropdown">Choose a workflow for your request action rule:</label><br>
      <select id="workflowDropdown">
        <option>Loadingâ€¦</option>
      </select>
    </div>
<br>
    <div class="form-group">
      <label for="workflowStatusDropdown">Choose a workflow status for your request action rule:</label><br>
      <select id="workflowStatusDropdown" >
        <option>Loadingâ€¦</option>
      </select>
    </div>
<br>
<br>
     <button class="hrefButton" id="InstallRequestActionRule">
        Install Request Action Rule
      </button>
       <div class="loadingSpinner" id="InstallRequestActionRuleSpinner" role="status" style="display:none" aria-label="Loadingâ€¦"></div>
      <br><span id="InstalledRequestionActionRuleResponse"></span>
      <br>
      <ul class="modal-steps">
       <li>
      </li>
    </ul>
  </div>
</div>
`);
                        $('#ct100_overlay_id1').hide();
                        $('#ctl00_ctl00_cph_maintenance_worksWithMsm').removeClass('unsigned');
                        $('#ctl00_ctl00_cph_maintenance_worksWithMsm').addClass('signed');
                        console.log("button should be working");
                        window.top.document.getElementById("requestActionMessageInstall").onclick = downloadRequestActionMessage;
                        window.top.document.getElementById("actionRuleInstall").addEventListener("click", OpenInstallRequestRuleDialog);
                        window.top.document.getElementById("InstallRequestActionRule").onclick = InstallRequestActionRule;
                        async function InstallRequestActionRule() {
                            event.preventDefault();
                            $('#InstallRequestActionRule').attr('disabled', true);
                            $('#InstallRequestActionRuleSpinner').show();
                            $('#InstalledRequestionActionRuleResponse').empty();
                            $('#InstalledRequestionActionRuleResponse').css('color', 'green');
                            var Workflow = $("#workflowDropdown  option:selected").text();
                            var WorkflowStatus = $("#workflowStatusDropdown  option:selected").text();
                            if (Workflow === '-- Select a Workflow --' || WorkflowStatus === '-- Select a Workflow Status --') {
                                $('#InstalledRequestionActionRuleResponse').empty();
                                $('#InstallRequestActionRule').attr('disabled', false);
                                $('#InstalledRequestionActionRuleResponse').append('You must specify an attribute for each item');
                                $('#InstalledRequestionActionRuleResponse').css('color', 'red');
                                $('#InstallRequestActionRuleSpinner').hide();
                                return;
                            } else {

                                console.log("Selected is ", $("#workflowStatusDropdown option:selected"));
                                var WorkflowStatusId = $("#workflowStatusDropdown option:selected").val();
                                var WorkflowId = $("#workflowDropdown option:selected").val();
                                const encodedFullUrl = encodeURI(_fullPluginPathHandler);
                                //console.log("we ")

                                var createActionRule = await (await fetch(_fullPluginPathHandler, {
                                    "method": "POST",
                                    body: JSON.stringify({ actionMessageId: Sharepoint._requestActionMessageID, actionMessageURL: encodedFullUrl, WorkflowStatusId: WorkflowStatusId, WorkflowId: WorkflowId, action: "createActionRule" }),
                                    "headers": [["content-type", "application/json"]]
                                })).json();

                                $('#InstallRequestActionRuleSpinner').hide();
                                $('#InstallRequestActionRule').attr('disabled', false);
                                $('#InstalledRequestionActionRuleResponse').append(createActionRule.response);


                            }

                        }

                        function checkRequestActionMessageExists() {
                            var requestActionMessageName = "Sharepoint Integration Message - Automated";
                            var foundItem = false;
                            $.get('/MSM/RFP/Forms/RequestActionMessage.aspx', function (html) {
                                $(html).find('#ctl00_ctl00_ctl00_cph_existingEntitiesContentPlaceHolder_ExistingEntitiesList_loadMoreList_items a.item')

                                    .each(function () {

                                        if ($(this).attr('title') == requestActionMessageName) {

                                            foundItem = true;
                                            Sharepoint._requestActionMessageID = $(this).attr('href').match(/id=(\d+)$/)[1];
                                        }
                                        // console.log($(this).attr('search'));

                                    });
                                if (foundItem == true) {

                                    //  $('#isRequestActionMessageInstalled').append('You have a request action message in your list of request action messages <a href="/MSM/RFP/Forms/RequestActionMessage.aspx" >here</a>, you do not need to install it.');
                                    $('#pluginStatus').append('<br><span style="color:green">You have a request action message in your list of request action messages <a href="/MSM/RFP/Forms/RequestActionMessage.aspx" >here</a>, you do not need to install it.</span>');
                                    //   $('#isRequestActionMessageInstalled').css('color', 'green');
                                    //   $('#isRequestActionMessageInstalled').attr('')
                                } else {
                                    $('#pluginStatus').append('<span style="color:red"><br>You currently do not have the action message installed, click the button above to install it.<br>Once installed, it will appear in the list <a href="/MSM/RFP/Forms/RequestActionMessage.aspx">here</a> as an item called "Sharepoint Integration Message - Automated</span>"');
                                    // $('#isRequestActionMessageInstalled').append('You currently do not have the action message installed, click the button above to install it.<br>Once installed, it will appear in the list <a href="/MSM/RFP/Forms/RequestActionMessage.aspx">here</a> as an item called "Sharepoint Integration Message - Automated"');
                                    //  $('#isRequestActionMessageInstalled').css('color', 'red');
                                }
                            })
                                .fail(function () {
                                    // //  $select.empty()
                                    //     .append('<option disabled>Error loading list</option>');
                                });

                        }

                        async function toggleFolder(folderId) {
                            if (loadingFolders.has(folderId)) return;

                            const isExpanded = expandedFolders.has(folderId);

                            if (isExpanded) {
                                // Collapse folder
                                expandedFolders.delete(folderId);
                                const childrenContainer = document.querySelector(`[data-children-of="${folderId}"]`);
                                if (childrenContainer) {
                                    childrenContainer.remove();
                                }
                            } else {
                                // Expand folder
                                expandedFolders.add(folderId);

                                // Check if we need to load children
                                if (!folderData[folderId]) {
                                    loadingFolders.add(folderId);
                                    updateTreeItem(folderId);

                                    try {
                                        const response = await fetchChildren(folderId);
                                        folderData[folderId] = response.value;
                                        //if (response.ok) {
                                        //    renderChildren(folderId);
                                        //}
                                    } catch (error) {
                                        console.error('Error fetching children:', error);
                                        expandedFolders.delete(folderId);
                                    } finally {
                                        loadingFolders.delete(folderId);
                                    }
                                }

                                // Render children
                                renderChildren(folderId);
                            }

                            updateTreeItem(folderId);
                        }


                        async function getLatestPluginVersion() {

                            var url = "https://raw.githubusercontent.com/Marval-Global/SharepointPlugin/refs/heads/main/manifest.json";
                            var githubPluginVersion = await (await fetch(url)).json();
                            var pagePluginVersion = $('#ctl00_ctl00_cph_maintenance_version').text();

                            if (pagePluginVersion == githubPluginVersion.Version) {
                                $('#ctl00_ctl00_cph_maintenance_version').css("color", "green");
                                $('#ctl00_ctl00_cph_maintenance_version').css("font-weight", "bold"); _popup

                                $('#uptodatemessage').fadeIn(250);
                                setTimeout(() => {
                                    $('#uptodatemessage').fadeOut(1000);
                                }, 2000);
                            } else {
                                $('#ctl00_ctl00_cph_maintenance_version').css("color", "red");
                                $('#ctl00_ctl00_cph_maintenance_version').css("font-weight", "bold");
                                $('#ctl00_ctl00_cph_maintenance_version').append(' - Plugin requires updating. Click <a href="https://github.com/Marval-Global/SharepointPlugin/releases/latest/download/MarvalSoftware.Plugins.Sharepoint.zip">here</a> for the new version.');
                            }
                        }

                        $(document).ready(function () {

                            getLatestPluginVersion();
                        });
                    }
                    else if (!currentUrl.includes("Plugin.aspx")) { //not on plugin page


                        //fetchSharePointSites();
                        //this._getAuth()
                        this._setUpQuickMenu();
                        this._requestNumber = MarvalSoftware.UI.Controls.ScriptManager.getInstance().getPage().getRequestNumber();
                        this._requestID = MarvalSoftware.UI.Controls.ScriptManager.getInstance().getPage()._requestId;
                        console.log(MarvalSoftware.UI.Controls.ScriptManager.getInstance().getPage());
                        this._requestDescription = MarvalSoftware.UI.Controls.ScriptManager.getInstance().getPage()._requestDescription;
                        this._contactEmail = MarvalSoftware.UI.Controls.ScriptManager.getInstance().getPage().getContactPreferredEmail();

                        //let foldersDropdown = document.getElementById("foldersDropdown");
                        //if (!foldersDropdown) {
                        //    console.log("does not exist");
                        //}

                        //document.getElementById("foldersDropdown").addEventListener("click", function (e) {
                        //    getAllFolders(e.target.value);
                        //});


                        addIconColumnFirst(this._getPluginPath() + "img/sharepoint_16.png", function ($row, index, eventTarget) {
                            Sharepoint._rowIndex = index + 1;
                            Sharepoint._attachmentName = $row.attr("title");
                            Sharepoint._popup(eventTarget);
                            //fetchSharePointSites();

                            //alert(`Clicked row ${index + 1}`);
                            //Sharepoint._rowIndex = index;
                        });

                        //displayGroups();


                    }

                    async function getAllFolders(siteId) {
                        //Sharepoint._getAuth();
                        console.log("we are calling GETALLFOLDERS");
                        let apptoken = Sharepoint.microsoftToken;
                        console.log("apptokenhere is ", apptoken);
                        // console.log("apptoken is:", apptoken);
                        try {
                            //const clientIdUrl = this._getPluginPath() + "handler/APIHandler.ashx?endpoint=ClientID"

                            //  console.log("apptoken is:", apptoken);
                            const response = await fetch(_fullPluginPathHandler + "?endpoint=getAllFolders", {
                                method: "POST",
                                "headers": [["content-type", "application/json"]],
                                body: JSON.stringify({
                                    "apptoken": apptoken,
                                    "siteId": siteId
                                })
                                // headers:{'apptoken':apptoken}

                            });
                            let foldersJson = await response.json(); //response promise

                            //console.log("All folders are: ", foldersJson);

                            //console.log("we should be appending folders now");
                            //let $dropdown = $('#foldersDropdown');
                            //if ($dropdown) {
                            //    console.log("folders dropdown does exist");
                            //}
                            //$dropdown.empty();
                            //$dropdown.append('<option value = "">-- Select a Folder --</option>');

                            //sitesJson.value.forEach(site => {
                            //    //console.log("folder here is", site);
                            //    $dropdown.append($('<option>').val(site.id).text(site.name));
                            //});
                            //console.log("appending should finish!");

                            //; //in theory should have all our sites if response is correct


                        } catch (error) {
                            console.log("Error fetching sites: ", error);
                        }
                    }




                    function addIconColumnFirst(imageSrc, onClickCallback) {
                        const $table = $('.attachments table.related');
                        const $theadRow = $table.find('thead tr');
                        const $tbodyRows = $table.find('tbody tr').not('.noAttachmentsMessage');

                        // 1. Add an empty <th> at the start
                        $theadRow.prepend(`<th class="icon-column"></th>`);

                        // 2. Add an icon <td> at the start of each row
                        $tbodyRows.each(function (index) {
                            const $row = $(this);
                            const $icon = $(`
            <td class="icon-column">
                <a href="#" class="icon-link" title="Open SharePoint">
                    <img src="${imageSrc}" alt="icon" style="width:16px; height:16px; cursor:pointer;" />
                </a>
            </td>
        `);

                            // Optional: attach click handler if needed now
                            if (typeof onClickCallback === 'function') {
                                $icon.find('a.icon-link').on('click', function (e) {
                                    e.preventDefault();
                                    onClickCallback($row, index, e.target);
                                });
                            }

                            $row.prepend($icon);
                        });
                    }



                    async function downloadRequestActionMessage() { //should be an async function
                        event.preventDefault();
                        console.log("we are calling download request action message");
                        var actionMessageText = `

@{
    var lastNote = (Model.Notes != null && Model.Notes.Count > 0)
        ? Model.Notes[Model.Notes.Count - 1]
        : null;

var requestDescription = @Model.Description;
var fullMessage = "";
}

@if (lastNote != null)
{
fullMessage=  "<b>Description:</b><br> " + requestDescription+ "<br> <b>Last Note:</b><br> " + @lastNote.Content + "<br><b>Last Note Created On:</b><br> "+@lastNote.Created + "<br> <b>Last Note Author</b><br> " + @lastNote.Author + " <br> <b>Service Name:</b><br>"+@Model.Service.Name + "<br>";

}


{
                           "Identifier": @Model.Identifier,

                           "ContactName": "@Model.LastUpdatedBy.Name.GivenName @Model.LastUpdatedBy.Name.FamilyName ",
                           "Email": "@Model.PreferredNotification.Address",
                        "message": "@fullMessage",
"serviceName": "@Model.Service.Name",
"action": "SendSharepointMessage"


                        }

                            `;
                        var currentUrl = window.top.location.host;
                        var pluginPathHandler = "https://" + currentUrl + Sharepoint._getPluginPath() + "handler/ApiHandler.ashx";
                        //$('#InstallRequestActionMessage').attr('disabled', true);

                        console.log("actionmsgtext: ", actionMessageText);
                        var snippetFile = await (await fetch(pluginPathHandler, {
                            "method": "POST",
                            body: JSON.stringify({ action: "createActionMessage", actionMessageText: actionMessageText }),
                            "headers": [["content-type", "application/json"]]
                        })).json();
                        console.log("response is: ", snippetFile);
                        $('#InstallRequestActionMessageSpinner').hide();
                        $('#InstallRequestActionMessage').attr('disabled', false);
                        $('#requestActionMessageResponse').append(snippetFile.response);
                        $('#requestActionMessageResponse').css('color', 'green');
                        //  console.log("Have snippet as ", snippetFile);
                    }




                },
                _showInlineFolderInput(parentFolderId) {
                    console.log("calliog inline fun")
                    const self = this;

                    // Find the parent folder element using data-item-id
                    const parentElement = document.querySelector(`[data-item-id="${parentFolderId}"]`);
                    if (!parentElement) return;

                    // Check if there's already an input being shown
                    const existingInput = parentElement.querySelector('.inline-folder-input');
                    if (existingInput) {
                        existingInput.focus();
                        return;
                    }

                    // Create the inline input container with proper indentation
                    const parentLevel = parseInt(parentElement.style.paddingLeft) || 0;
                    const inputContainer = document.createElement('div');
                    inputContainer.className = 'inline-folder-input tree-item';
                    inputContainer.style.cssText = `
        display: flex;
        align-items: center;
        padding-left: ${parentLevel + 20}px;
        padding-right: 8px;
        padding-top: 4px;
        padding-bottom: 4px;
        margin: 2px 0;
        background: #f8f9fa;
        border: 1px solid #ddd;
        border-radius: 4px;
    `;

                    // Create the input field
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.text = "Hi"
                    input.placeholder = 'New ddd name';
                    input.style.cssText = `
        flex: 1;
        border: none;
        background: transparent;
        outline: none;
        font-size: 14px;
        padding: 2px 4px;
    `;

                    // Create confirm button (checkmark)
                    const confirmBtn = document.createElement('button');
                    confirmBtn.innerHTML = 'âœ“'; // You can replace with your icons.check if you have one
                    confirmBtn.title = 'Create folder';
                    confirmBtn.style.cssText = `
        background: #28a745;
        color: white;
        border: none;
        border-radius: 3px;
        padding: 4px 8px;
        margin-left: 4px;
        cursor: pointer;
        font-size: 12px;
    `;

                    // Create cancel button
                    const cancelBtn = document.createElement('button');
                    cancelBtn.innerHTML = 'âœ•'; // You can replace with your icons.close if you have one
                    cancelBtn.title = 'Cancel';
                    cancelBtn.style.cssText = `
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 3px;
        padding: 4px 8px;
        margin-left: 4px;
        cursor: pointer;
        font-size: 12px;
    `;

                    // Function to create the folder
                    const createFolder = async () => {
                        const folderName = input.value.trim();
                        if (!folderName) {
                            input.focus();
                            return;
                        }

                        try {
                            // Call your API or method to create the folder
                            await self._createNewFolder(parentFolderId, folderName);

                            // Remove the input container
                            inputContainer.remove();

                            // Refresh the folder contents or add the new folder to the UI
                            await self._refreshFolderContents(parentFolderId);

                        } catch (error) {
                            console.error('Error creating folder:', error);
                            // You might want to show an error message here
                            input.style.borderColor = '#dc3545';
                            input.focus();
                        }
                    };

                    // Function to cancel folder creation
                    const cancelCreation = () => {
                        inputContainer.remove();
                    };

                    // Event listeners
                    confirmBtn.addEventListener('click', createFolder);
                    cancelBtn.addEventListener('click', cancelCreation);

                    // Handle Enter and Escape keys
                    input.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            createFolder();
                        } else if (e.key === 'Escape') {
                            e.preventDefault();
                            cancelCreation();
                        }
                    });

                    // Click outside to cancel
                    const handleClickOutside = (e) => {
                        if (!inputContainer.contains(e.target)) {
                            cancelCreation();
                            document.removeEventListener('click', handleClickOutside);
                        }
                    };

                    // Add elements to container
                    inputContainer.appendChild(input);
                    inputContainer.appendChild(confirmBtn);
                    inputContainer.appendChild(cancelBtn);

                    // Find where to insert the input - after the current tree item
                    // Look for the next sibling that has a deeper or equal padding level to insert before it
                    let insertAfter = parentElement;
                    let nextSibling = parentElement.nextElementSibling;

                    // If the folder is expanded, find where the children end
                    if (expandedFolders.has(parentFolderId) && nextSibling) {
                        const parentLevel = parseInt(parentElement.style.paddingLeft) || 0;

                        // Skip over all child elements (they will have more padding)
                        while (nextSibling && parseInt(nextSibling.style.paddingLeft || 0) > parentLevel) {
                            insertAfter = nextSibling;
                            nextSibling = nextSibling.nextElementSibling;
                        }
                    }

                    // Insert the input container after the determined position
                    insertAfter.insertAdjacentElement('afterend', inputContainer);

                    // Focus the input and select all text
                    input.focus();

                    // Add click outside listener after a short delay to prevent immediate trigger
                    setTimeout(() => {
                        document.addEventListener('click', handleClickOutside);
                    }, 100);
                },

                _fetchSharePointSites: async function () {
                    //Sharepoint._getAuth();
                    console.log("we are calling fetchsharepointsites");
                    //let apptoken = await getMicrosoftAccessToken();
                    let apptoken = await this._getMicrosoftAccessToken2();
                    //console.log("apptoken is:", apptoken);
                    try {
                        //const clientIdUrl = this._getPluginPath() + "handler/APIHandler.ashx?endpoint=ClientID"

                        //  console.log("apptoken is:", apptoken);
                        const response = await fetch(_fullPluginPathHandler + "?endpoint=getSites", {
                            method: "POST",
                            "headers": [["content-type", "application/json"]],
                            body: JSON.stringify({
                                "apptoken": apptoken,
                                endpoint: "getSites"
                            })
                            // headers:{'apptoken':apptoken}

                        });
                        let sitesJson = await response.json()

                        console.log("Sharepoint sites are: ", sitesJson);

                        console.log("we should be appending sites now");
                        let $dropdown = $('#sitesDropdown');
                        if ($dropdown) {
                            console.log("sites dropdown does exist");
                        }
                        $dropdown.empty();
                        $dropdown.append('<option value = "">Please Select A Website To Upload</option>');

                        sitesJson.value.forEach(site => {
                            //console.log("site here is", site);
                            $dropdown.append($('<option>').val(site.id).text(site.name || site.webUrl));
                        });
                        console.log("appending should finish!");

                        ; //in theory should have all our sites if response is correct


                    } catch (error) {
                        console.log("Error fetching sites: ", error);
                    }
                }
            
            ,
                _getAuth: async function () {

                    let hostString = await (await fetch(Sharepoint._getPluginPath() + "handler/APIHandler.ashx?endpoint=ChatbotHostOverride")).text()
                    let tenantId = await (await fetch(Sharepoint._getPluginPath() + "handler/APIHandler.ashx?endpoint=TenantID")).text()
                    let secret = await (await fetch(Sharepoint._getPluginPath() + "handler/APIHandler.ashx?endpoint=SecretKey")).text()




                    var url = Sharepoint._getPluginPath() + "handler/APIHandler.ashx?endpoint=ClientID"

                    //var id = await (await fetch(url)).text()

                    const msalInstance = await msal.createStandardPublicClientApplication({
                        auth: {
                            clientId: "b6a84976-d3bc-4f7d-ae42-a50472a64116",
                            authority: "https://login.microsoftonline.com/common/oauth2/v2.0/authorize"
                        },
                    });

                    var loginRequest = {
                        scopes: ["https://graph.microsoft.com/.default"]
                    };

                    try {
                        var response = await msalInstance.loginPopup(loginRequest);

                        try {
                            const result = await (await fetch("https://graph.microsoft.com/v1.0/users?$filter=userPrincipalName eq '" + Sharepoint._contactEmail + "'", {

                                method: "GET",
                                headers: new Headers({
                                    "Authorization": "Bearer " + response.accessToken,
                                })
                            })).json()

                            console.log(response.accessToken);

                            if (result.value.length < 1) {
                                throw Error("Search for contact returned no results.")
                            } else {

                            }

                        } catch (err) {
                            $("#SharepointError").remove();
                            $("#SharepointPopup").append("<div id='SharepointError'><br><p style='color: red;'>Unable to find a Sharepoint contact for " + Sharepoint._contactEmail + "</p></div>")
                            console.error("Sharepoint search error:\n", err)
                            $("*").remove(".chatbot-container")
                        }

                    } catch (err) {
                        $("#SharepointError").remove();
                        $("#SharepointPopup").append("<div id='SharepointError'><br><p style='color: red;'>Unable to authenticate with Microsoft</p></div>")
                        $("*").remove(".chatbot-container")
                        console.error("MS Auth error:\n", err)
                    }


                },

                _uploadToSharepoint: function (sender, e) {
                    e.preventDefault();

                    let sitesDropdown = $("#sitesDropdown");
                    //let foldersDropdown = $("#foldersDropdown");

                    var payload = {
                        message: formulatedMessage,
                        action: "SendSharepointMessage",
                        //siteId: sitesDropdown.val(),
                        // folderId: foldersDropdown.val() //jquery is .val()
                    }
                    //if (window.top.document.getElementById("CheckBox").checked) {
                    //    var formulatedMessage = messageText + " under request number: " + this._requestNumber + ", request ID: " + this._requestID + ", the request description: " + description + ", from :" + email;
                    //    payload = {
                    //        message: formulatedMessage,
                    //        action: "SendSharepointMessage"
                    //    }
                    //} else {//not checked
                    //    payload = {
                    //        message: messageText,
                    //        action: "SendSharepointMessage"
                    //    }
                    //}
                    //console.log("We are here");



                    $.ajax({
                        type: "POST",
                        url: this._getPluginPath() + "handler/ApiHandler.ashx?action=SendSharepointMessage",
                        contentType: "application/json; charset=utf-8",
                        dataType: "json",
                        data: JSON.stringify(payload),
                        success: function (result) {
                            if (Object.keys(result).length > 0) {
                                this._errorPopup(result);
                            }
                            else {
                                //this._popup();
                            }
                        }.bind(this)
                    });
                },

                _getPluginPath: function () {
                    return this.attributes["data-pluginpath"].value;
                },

                _getPluginId: function () {
                    return this.attributes["data-pluginid"].value;
                },

                _getPluginCulture: function () {
                    return this.attributes["data-pluginculture"].value;
                },

                _getString: function (key, formatObject) {
                    if (MarvalSoftware.Plugins.PluginResourceManager) {
                        return MarvalSoftware.Plugins.PluginResourceManager.getInstance()
                            .getString(this._getPluginId(), key, this._getPluginCulture(), formatObject);
                    } else {
                        return key;
                    }
                },
                //_updateButtonVisual() {
                //    if (window.top.document.getElementById("message").value != "" && window.top.document.getElementById("groupsDropdown").value != "") {
                //        window.top.document.getElementById("sendMessage").style.backgroundColor = "green";
                //        window.top.document.getElementById("sendMessage").disabled = false;
                //    } else {
                //        window.top.document.getElementById("sendMessage").style.backgroundColor = "gray";
                //        window.top.document.getElementById("sendMessage").disabled = true;
                //    }
                //},

                _getMicrosoftAccessToken2: async function () {
                    // If we already have a valid token, return it
                    if (Sharepoint._microsoftToken) {
                        return Sharepoint._microsoftToken;
                    }

                    // If login is already in progress, return the existing promise
                    if (Sharepoint._loginPromise) {
                        console.warn("Login already in progress, waiting for completion...");
                        return await Sharepoint._loginPromise;
                    }

                    // Create and store the login promise
                    Sharepoint._loginPromise = this._performLogin();

                    try {
                        const token = await Sharepoint._loginPromise;
                        return token;
                    } finally {
                        // Clear the promise when done (success or failure)
                        Sharepoint._loginPromise = null;
                    }
                },

                _performLogin: async function () {
                    try {
                        // Get the Client ID from your SharePoint handler or hardcode it here
                        const clientIdUrl = _fullPluginPathHandler + "?endpoint=ClientID";
                        console.log("clientIdUrl");
                        const clientId = await (await fetch(clientIdUrl)).text();
                        console.log("client id is:", clientId);

                        const msalInstance = await msal.createStandardPublicClientApplication({
                            auth: {
                                clientId: clientId,
                                authority: "https://login.microsoftonline.com/common"
                            }
                        });

                        const loginRequest = {
                            scopes: ["https://graph.microsoft.com/.default"]
                        };

                        const response = await msalInstance.loginPopup(loginRequest);
                        console.log("Logged in successfully, access token:", response.accessToken);

                        Sharepoint._microsoftToken = response.accessToken;
                        return response.accessToken;

                    } catch (err) {
                        console.error("MSAL login failed:", err);
                        throw err;
                    }
                },

                _renderElement: function () {

                    var eventManager = MarvalSoftware.UI.Dom.EventManager.getInstance();
                    var template = document.querySelector("template").content;
                    this._element = window.top.document.importNode(template, true);


                    this._cards = this._element.querySelector(".cards");

                    this._createElement = this._element.querySelector(".action-buttons > button");
                    this._refreshLink = this._element.querySelector("a");


                    let attachmentsPageButton = $("#AttachmentsPage");
                    //attachmentsPageButton.click

                    //attachmentsPageButton.click(function (e) {
                    //    e.preventDefault();
                        
                    //    //Sharepoint._uploadAllAttachments();
                    //});

                    this.siteSelected = this._element.querySelector("#sitesDropdown");
                    eventManager.addHandler(this.siteSelected, "input", this._printSiteId, this);
                    eventManager.addHandler(this.siteSelected, "input", function (e) {
                        this._getAllFolders(e.value);
                        //this._getAllFolders(e.value, "test:");
                        $("#treeContainer").css("display", "show");
                        this._renderTree();//call when we seelect a site
                        console.log("we should be calling get all folders twice and getting the response ");

                    }, this); //should be appending all folders now

                    this.appendChild(this._element);
                },
                //_consoleLogFolder: function () {
                //    let res = await Sharepoint._getAllFolders();
                //},

                _trimWhiteSpaces: function (element) {
                    var value = element.value;
                    value = value.replace(/(^\s*)|(\s*$)/gi, "");
                    value = value.replace(/[ ]{2,}/gi, " ");
                    value = value.replace(/\n /, "\n");
                    element.value = value;
                }, _getAllNotes: async function (sender, e) {
                    //preventDefault(); //prevent default everytime
                    let sitesDropdown = $("#sitesDropdown"); // need table



                    try {
                        console.log(" getting all attachments ");
                        let reqId = MarvalSoftware.UI.Controls.ScriptManager.getInstance().getPage()._requestId;
                        let url = this._getPluginPath() + "handler/APIHandler.ashx?endpoint=getAllNotes&reqId=" + reqId;
                        console.log("we are going to this attachment url ", url)

                        console.log("url is", url);
                        let result = await fetch(url, {
                            method: "GET",
                            headers: {
                                "Content-Type": "application/json; charset=utf-8"
                            },
                        });
                        if (!result.ok) {
                            let errorText = await result.text();
                            throw new Error(`HTTP error ${result.status}: ${errorText}`);
                        }

                        let notes = await result.json();
                        console.log("notes feedback", notes);
                        // Clear existing rows (including the "(Empty)" row)
                        let notesDiv = window.top.document.getElementById("notesDiv");
                        if (notesDiv) {
                            console.log("notes div exists and we are appending to it", notesDiv);
                        }

                        // Clear old content
                        notesDiv.innerHTML = "";

                        // Loop through notes and create elements
                        notes.collection.items.forEach(note => {
                            let noteInfo = note.entity.data;
                            let fileName = `${noteInfo.type} ${noteInfo.createdOn} ${noteInfo.author.name}`;
                            let summary = noteInfo.contentSummary;

                            // Create a container for each note
                            let container = document.createElement("div");
                            container.className = "note2-item";
                            //container.style.marginBottom = "12px";
                            //container.style.padding = "6px 0";
                            //container.style.borderBottom = "1px solid #ddd";

                            // Create the checkbox
                            let checkbox = document.createElement("input");
                            checkbox.type = "checkbox";
                            checkbox.name = "selectAttachment";
                            checkbox.value = fileName;

                            let uploadButton = window.top.document.getElementById("uploadButtonTwo");
                            //uploadButton.style.display = "block";

                            console.log("upload button ", uploadButton);
                            checkbox.setAttribute("data-attachment-id", noteInfo.id);
                            checkbox.onchange = function () {
                                if (this.checked) {
                                    container.style.background = 'linear-gradient(135deg, rgba(50, 192, 240, 0.2), rgba(120, 103, 173, 0.2))';
                                    container.style.transform = 'scale(1.02)';
                                    uploadButton.style.display = "block";

                                } else {
                                    let uploadButton = window.top.document.getElementById("uploadButtonTwo");
                                    uploadButton.style.display = "none";
                                    container.style.background = '';
                                    container.style.transform = '';
                                }
                            };
                            //summaryDiv.className = "note-summary"; // <-- add this
                            //checkbox.style.marginRight = "8px";

                            // Create the label
                            let label = document.createElement("label");
                            label.textContent = fileName;
                            label.style.fontWeight = "bold";

                            // Create a summary element
                            let summaryDiv = document.createElement("div");
                            summaryDiv.textContent = summary;
                            //summaryDiv.style.marginLeft = "26px"; // align under label text
                            //summaryDiv.style.color = "#555";
                            //summaryDiv.style.fontSize = "0.9em";
                            summaryDiv.className = "note2-summary"; // <-- add this

                            // Append to container
                            container.appendChild(checkbox);
                            container.appendChild(label);
                            container.appendChild(summaryDiv);

                            // Append container to notes div

                            notesDiv.appendChild(container);

                        });


                    } catch (ex) {
                        console.error("we have error", ex);
                    }

                },
                _getAllAttachments: async function (sender, e) {
                    //preventDefault(); //prevent default everytime
                    let sitesDropdown = $("#sitesDropdown"); // need table
                    //let itemsTable = $("#itemsTable tbody");

                    try {
                        console.log(" getting all attachments ");
                        let reqId = MarvalSoftware.UI.Controls.ScriptManager.getInstance().getPage()._requestId;
                        let url = this._getPluginPath() + "handler/APIHandler.ashx?endpoint=getAllAttachments&reqId=" + reqId;
                        console.log("we are going to this attachment url ", url)

                        console.log("url is", url);
                        let result = await fetch(url, {
                            method: "GET",
                            headers: {
                                "Content-Type": "application/json; charset=utf-8"
                            },
                        });
                        if (!result.ok) {
                            let errorText = await result.text();
                            throw new Error(`HTTP error ${result.status}: ${errorText}`);
                        }

                        let attachment = await result.json();
                        console.log("attachmentS feedback", attachment);
                        // Clear existing rows (including the "(Empty)" row)
                        let attachmentsDiv = window.top.document.getElementById("attachmentsDiv");
                        if (attachmentsDiv) {
                            console.log("we found attachments div and we are now appending");
                        }
                        attachmentsDiv.innerHTML = ""; // clear previous

                        // Add new attachment elements
                        attachment.collection.items.forEach(attachmentItem => {
                            let fileName = attachmentItem.entity.data.fileName;
                            let id = attachmentItem.entity.data.id;

                            // Create container for the item
                            let container = document.createElement("div");
                            container.className = "attachment-item";
                            //container.style.marginBottom = "8px";

                            // Create checkbox
                            let checkbox = document.createElement("input");
                            checkbox.type = "checkbox";
                            checkbox.name = "selectAttachment";
                            checkbox.value = fileName;
                            checkbox.setAttribute("data-attachment-id", id);
                            checkbox.onchange = function () {
                                if (this.checked) {
                                    container.style.background = 'linear-gradient(135deg, rgba(50, 192, 240, 0.2), rgba(120, 103, 173, 0.2))';
                                    container.style.transform = 'scale(1.02)';
                                    let uploadButton = window.top.document.getElementById("uploadButtonTwo");
                                    uploadButton.style.display = "block";
                                } else {
                                    container.style.background = '';
                                    container.style.transform = '';
                                    let uploadButton = window.top.document.getElementById("uploadButtonTwo");
                                    uploadButton.style.display = "none";
                                }
                            };

                            // Create label or file name text
                            let label = document.createElement("label");
                            label.textContent = fileName;
                            //label.style.marginLeft = "8px";

                            // Append to container
                            container.appendChild(checkbox);
                            container.appendChild(label);

                            // Append container to the div
                            attachmentsDiv.appendChild(container);
                            console.log("appended attachments now");
                        });


                    } catch (ex) {
                        console.error("we have error", ex);
                    }

                },
                _appendSelectedItemsToFinalDiv: function () {
                    const FinalDiv = window.top.document.getElementById("FinalDiv");

                    if (!FinalDiv) {
                        console.warn("FinalDiv not found.");
                        return;
                    }

                    // Helper function to build a section
                    function _buildSection(title, checkboxes) {
                        if (checkboxes.length === 0) return;

                        const section = document.createElement("div");
                        section.className = "selected-section";

                        const header = document.createElement("h3");
                        header.textContent = title;
                        section.appendChild(header);

                        checkboxes.each(function () {
                            const label = document.createElement("div");
                            label.className = "selected-item";
                            label.textContent = this.getAttribute("data-label") || this.value || "Unnamed Item";
                            section.appendChild(label);
                        });

                        FinalDiv.appendChild(section);
                    }

                    // Gather selected checkboxes
                    const selectedNotes = $("#notesDiv input[type='checkbox']:checked");
                    const selectedEmails = $("#emailsDiv input[type='checkbox']:checked");
                    const selectedAttachments = $("#attachmentsDiv input[type='checkbox']:checked");

                    let folderPath = Sharepoint._currentPath;
                    let pathDiv = document.createElement("div");
                    pathDiv.innerText = folderPath;

                    FinalDiv.appendChild(pathDiv);

                    // Build sections and append them
                    _buildSection("ðŸ“ Selected Notes", selectedNotes);
                    _buildSection("ðŸ“§ Selected Emails", selectedEmails);
                    _buildSection("ðŸ“Ž Selected Attachments", selectedAttachments);
                },
                _uploadAllAttachments: async function (sender, e) {
                    //e.preventDefault();
                    console.log("we are calling upload all attachments");
                    //e.preventDefault();
                    let sitesDropdown = $("#sitesDropdown");
                    //let foldersDropdown = $("#foldersDropdown");
                    let reqId = MarvalSoftware.UI.Controls.ScriptManager.getInstance().getPage()._requestId;
                    let siteId = sitesDropdown.val();
                    //let folderId = foldersDropdown.find("option:selected").text(); // or `.val()` if you're using value instead
                    // Find all checked checkboxes in the attachments column
                    let checkedBoxes = $("#attachmentsDiv input[type='checkbox']:checked");
                    let notesBoxes = $("#notesDiv input[type='checkbox']:checked");
                    let emailBoxes = $("#emailsDiv input[type='checkbox']:checked");

                    //let isChecked = $("#createSubfolder").prop("checked");
                    let url = _fullPluginPathHandler + "?endpoint=AutomateSubfolderCreation";

                    let AutomateSubfolderCreation = "true"; //by default it is true
                    console.log("AutomateSubfolderCreation is ", AutomateSubfolderCreation);

                    let namingConvention = await (await fetch(_fullPluginPathHandler + "?endpoint=createFolderOption")).text(); //now we can get naming convention from bafckend
                    console.log("naming convention is ", namingConvention);
                    let folderName = "";

                    switch (namingConvention) { //set name based on the convention
                        case "MSM":
                            folderName = Sharepoint._requestAcronym + "-" + Sharepoint._requestNumber;
                            break
                        case "Custom Attribute":
                            folderName = customAttribute;
                            break
                        case "MSMAndCustomAttribute":
                            folderName = Sharepoint._requestAcronym + "-" + Sharepoint._requestNumber + "-" + customAttribute;
                            break
                        default:
                            AutomateSubfolderCreation = "false";
                            break;
                    }



                    if (AutomateSubfolderCreation === "true") { //so if none is selected in the textbox then we dont need to create a subfolder and upload all files normallly
                        let response = await Sharepoint._createFolder(folderName);//creating where we last clicked!
                        Sharepoint._currentPath += "/" + response.name;

                        //then we simply update the path and do the call
                    } else {
                        console.log("we do not need to automate subfolder creatioj");
                    }
                    //we should do create folder here first, then we can use the path and upload to that path!



                    console.log("all ticked email boxes are ", emailBoxes);
                    console.log("all ticked notes boxes are ", notesBoxes);
                    console.log("all ticked checked boxes are ", checkedBoxes);
                    if (checkedBoxes.length === 0 && notesBoxes.length === 0 && emailBoxes.length === 0) {
                        console.warn("No attachments selected.");
                        alert("Please select at least one attachment to upload.");
                        return;
                    }


                    //let folderPath = folderPaths[Sharepoint._currentSelectedFolderId] || "";
                    let folderPath = this._currentPath;
                    console.log("folder path in upallat ius ", folderPath);

                    try {
                        for (let emailbox of emailBoxes) {
                            let subject = $(emailbox).data("subject");
                            let address = $(emailbox).data("address");
                            let messageDate = $(emailbox).data("date");
                            

                            let identifier = emailbox.dataset.attachmentId;

                            console.log("Uploading email here:", subject, "with microsoft token ", Sharepoint._microsoftToken);

                            let url = this._getPluginPath() + "handler/APIHandler.ashx?endpoint=uploadEmail&reqId=" + reqId + "&identifier=" + identifier + "&attachmentName=" + subject + ".txt";

                            let payload = {
                                microsoftToken: Sharepoint._microsoftToken,
                                siteId: siteId,
                                folderId: folderPath,
                                address: address,
                                messageDate: messageDate,
                                //createSubfolder: isChecked
                            };

                            console.log("payload", payload);

                            try {
                                let result = await fetch(url, {
                                    method: "POST",
                                    headers: {
                                        "Content-Type": "application/json; charset=utf-8"
                                    },
                                    body: JSON.stringify(payload)
                                });

                                if (!result.ok) {
                                    let errorText = await result.text();
                                    throw new Error(`Error uploading "${subject}": ${result.status} - ${errorText}`);
                                }

                                let response = await result.json();
                                console.log(`Uploaded email: ${subject}`, response);
                                $("#successMessage")
                                    .text("Successfully uploaded emails")
                                    .css("color", "green")
                                    .fadeIn("slow")
                                    .delay(2000)
                                    .fadeOut("slow");

                            } catch (ex) {
                                console.error("Upload error for", subject, ex);
                                $("#successMessage")
                                    .text("Error could not upload notes")
                                    .css("color", "red")
                                    .fadeIn("slow")
                                    .delay(2000)
                                    .fadeOut("slow");
                            }
                        }

                        //let combineNotesBoolean =

                        let combineNotes = $("#combineNotesCheckbox").prop("checked");

                        if (combineNotes) {
                            console.log("check box is ticked!")
                            // Collect all summaries into one string
                            let combinedContent = "";

                            for (let notebox of notesBoxes) {
                                // Get the summary text (the note content)
                                let summaryText = $(notebox)
                                    .closest(".note2-item")
                                    .children("div")
                                    .last()
                                    .text()
                                    .trim();

                                // Extract time and author from the checkbox value
                                let valueParts = $(notebox).val().split(" ");
                                let time = valueParts[1]; // e.g., "2025-06-12T02:38:50.183Z"
                                let author = valueParts.slice(2).join(" "); // everything after time

                                combinedContent += `Time: ${time}\nAuthor: ${author}\nNote: ${summaryText}\n\n`;
                            }


                            console.log("combined content is ", combinedContent);
                            let url = this._getPluginPath() + "handler/APIHandler.ashx?endpoint=uploadCombinedNotes&reqId=" + reqId;
                            let customAttribute = await Sharepoint._getAllCustomAttributeValue();

                            console.log("custom att is ", customAttribute);
                            if (customAttribute === null) {
                                customAttribute = "";
                            }

                            let namingConvention = await (await fetch(_fullPluginPathHandler + "?endpoint=createFolderOption")); //now we can get naming convention from bafckend
                            console.log("naming convention is ", namingConvention);
                            switch (namingConvention) { //set name based on the convention
                                case "MSM":
                                    folderName = Sharepoint._requestAcronym + "-" + Sharepoint._requestNumber;
                                    break
                                case "Custom Attribute":
                                    folderName = customAttribute;
                                    break
                                case "MSMAndCustomAttribute":
                                    folderName = Sharepoint._requestAcronym + "-" + Sharepoint._requestNumber + "-" + customAttribute;
                                    break
                            }

                            let payload = {
                                microsoftToken: Sharepoint._microsoftToken,
                                siteId: siteId,
                                folderId: folderPath,
                                combinedText: combinedContent,
                                createSubfolder: isChecked,
                                attachmentName: folderName + " Combined Notes.txt"//we will use .trim after to condense it //should probably make this changable for the user
                            };

                            try {
                                let result = await fetch(url, {
                                    method: "POST",
                                    headers: {
                                        "Content-Type": "application/json; charset=utf-8"
                                    },
                                    body: JSON.stringify(payload)
                                });

                                if (!result.ok) {
                                    throw new Error(await result.text());
                                }

                                let response = await result.json();
                                console.log("Combined upload successful", response);
                                $("#successMessage").text("Uploaded combined notes").fadeIn("slow").delay(2000).fadeOut("slow").css("color", "green");

                            } catch (ex) {
                                console.error("Upload failed", ex);
                                $("#successMessage").text("Failed to upload combined notes").fadeIn("slow").delay(2000).fadeOut("slow").css("color", "red");
                            }

                            //return; // skip individual uploads
                        } else {
                            console.log("tickbox was not checked so we are uploading notes individually");
                            for (let notebox of notesBoxes) {
                                let attachmentName = notebox.value; // file name stored in value
                                let identifier = notebox.dataset.attachmentId; //checkboxes store the attachment data
                                let summaryText = notebox.closest(".note2-item").querySelector(".note2-summary").textContent.trim();


                                console.log("Uploading attachment:", summaryText);

                                //let folderPath = folderPaths[Sharepoint._currentSelectedFolderId] || "";

                                let url = this._getPluginPath() + "handler/APIHandler.ashx?endpoint=uploadNote&reqId=" + reqId + "&identifier=" + identifier + "&attachmentName=" + summaryText;
                                //should be uploading all notes
                                console.log("we are uploading notes to this url " + url);
                                console.log("current token is ", Sharepoint._microsoftToken)
                                let payload = {
                                    microsoftToken: Sharepoint._microsoftToken,
                                    siteId: siteId,
                                    folderId: folderPath,
                                    //createSubfolder: isChecked
                                };

                                try {
                                    let result = await fetch(url, {
                                        method: "POST",
                                        headers: {
                                            "Content-Type": "application/json; charset=utf-8"
                                        },
                                        body: JSON.stringify(payload)
                                    });

                                    if (!result.ok) {
                                        let errorText = await result.text();
                                        throw new Error(`Error uploading "${attachmentName}": ${result.status} - ${errorText}`);
                                    }

                                    let response = await result.json();
                                    console.log(`Uploaded: ${attachmentName}`, response);
                                    $("#successMessage")
                                        .text("Successfully uploaded notes")
                                        .fadeIn("slow")      // Fade in
                                        .delay(2000)         // Wait 2 seconds
                                        .fadeOut("slow")    // Then fade out
                                        .css("color", "green");

                                } catch (ex) {
                                    console.error("Upload error for", ex);
                                    $("#successMessage")
                                        .text("Error could not upload notes")
                                        .fadeIn("slow")      // Fade in
                                        .delay(2000)         // Wait 2 seconds
                                        .fadeOut("slow")
                                        .css("color", "red");
                                }
                            }
                        }


                        for (let checkbox of checkedBoxes) {
                            let attachmentName = checkbox.value; // file name stored in value
                            let identifier = checkbox.dataset.attachmentId; //checkboxes store the attachment data

                            console.log("Uploading attachment:", attachmentName);

                            let url = this._getPluginPath() + "handler/APIHandler.ashx?endpoint=getAttachment&reqId=" + reqId + "&identifier=" + identifier + "&attachmentName=" + attachmentName;
                            //should change backend getAttachment name to something better
                            console.log("we are uploading files to this url " + url);
                            let payload = {
                                microsoftToken: Sharepoint._microsoftToken,
                                siteId: siteId,
                                folderId: folderPath,
                                //createSubfolder: isChecked
                            };

                            try {
                                let result = await fetch(url, {
                                    method: "POST",
                                    headers: {
                                        "Content-Type": "application/json; charset=utf-8"
                                    },
                                    body: JSON.stringify(payload)
                                });

                                if (!result.ok) {
                                    let errorText = await result.text();
                                    throw new Error(`Error uploading "${attachmentName}": ${result.status} - ${errorText}`);
                                }

                                let response = await result.json();
                                console.log(`Uploaded: ${attachmentName}`, response);
                                $("#successMessage")
                                    .text("Successfully uploaded attachments")
                                    .fadeIn("slow")      // Fade in
                                    .delay(2000)         // Wait 2 seconds
                                    .fadeOut("slow");    // Then fade out

                            } catch (ex) {
                                console.error("Upload error for", attachmentName, ex);
                                $("#successMessage")
                                    .text("Error could not upload attachments")
                                    .fadeIn("slow")      // Fade in
                                    .delay(2000)         // Wait 2 seconds
                                    .fadeOut("slow");
                            }
                        }
                        console.log("we are cleariing checkboxes")
                        checkedBoxes.each(function () {
                            $(this).prop("checked", false);
                        });
                        notesBoxes.each(function () {
                            $(this).prop("checked", false);
                        });
                        emailBoxes.each(function () {
                            $(this).prop("checked", false);
                        });
                        let url = this._getPluginPath() + "handler/APIHandler.ashx?endpoint=createUploadNote&reqId=" + reqId;
                        let res = await fetch(url, {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json; charset=utf-8"
                            },
                            body: JSON.stringify({})
                        });
                        if (!res.ok) {
                            let errorText = await res.text();
                            throw new Error(`Error uploading}": ${res.status} - ${errorText}`);
                        }
                        //let response = await res.json();
                        console.log("Uploaded: successfully");
                        $("#uploadButtonTwo").hide();
                        $("#combineNotesCheckbox").prop("checked", false);


                    } catch (ex) {
                        console.error("Upload error for", ex);
                        $("#successMessage")
                            .text("Error could not upload attachments")
                            .fadeIn("slow")      // Fade in
                            .delay(2000)         // Wait 2 seconds
                            .fadeOut("slow");
                    }


                },


                _getAttachment: async function (sender, e, identifier = null) {
                    e.preventDefault(); //prevent default everytime
                    let sitesDropdown = $("#sitesDropdown");
                    //let foldersDropdown = $("#foldersDropdown");

                    try {
                        //console.log("req id is", reqId, "identifier is ", this._rowIndex);
                        console.log(" we are calling get attachment now");
                        let reqId = MarvalSoftware.UI.Controls.ScriptManager.getInstance().getPage()._requestId;
                        console.log("req id is", reqId, "identifier is ", this._rowIndex);
                        let url = this._getPluginPath() + "handler/APIHandler.ashx?endpoint=getAttachment&reqId=" + reqId + "&identifier=" + this._rowIndex + "&attachmentName=" + Sharepoint._attachmentName;
                        console.log("we are going to this attachment url ", url);
                        //console.log("site id is", sitesDropdown.val(), "folderid is", foldersDropdown.find("option:selected").text());

                        let payLoad = {
                            microsoftToken: Sharepoint._microsoftToken,
                            siteId: sitesDropdown.val(),
                            folderId: foldersDropdown.find("option:selected").text()

                        }
                        console.log("url is", url);
                        let result = await fetch(url, {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json; charset=utf-8"
                            },
                            body: JSON.stringify(payLoad)
                        });
                        if (!result.ok) {
                            let errorText = await result.text();
                            throw new Error(`HTTP error ${result.status}: ${errorText}`);
                        }

                        let attachment = await result.json();
                        console.log("attachment feedback", attachment);

                        //return attachment;

                    } catch (ex) {
                        console.error("we have error", ex);
                    }

                },
                _getAllEmails: async function () {
                    try {
                        console.log(" getting all emails ");
                        let reqId = MarvalSoftware.UI.Controls.ScriptManager.getInstance().getPage()._requestId;
                        let url = "https://localhost/MSM/RFP/Forms/RequestEmailAuditViewer.aspx?id=" + reqId;
                        console.log("we are going to this email url ", url)

                        console.log("url is", url);
                        let result = await fetch(url, {
                            method: "GET",
                            headers: {
                                "Content-Type": "application/json; charset=utf-8"
                            },
                        });
                        if (!result.ok) {
                            let errorText = await result.text();
                            throw new Error(`HTTP error ${result.status}: ${errorText}`);
                        }

                        let emails = await result.text();
                        let emailsHtml = $(emails);
                        let emailsBody = emailsHtml.find("#ctl00_cph_grid_body");

                        // Find all clickable email rows
                        let emailRows = emailsBody.find("a.row.clickable");

                        emailRows.each(function () {
                            let row = $(this);
                            let cells = row.find(".cell-default.cell-body");

                            let messageDate = cells.eq(0).text().trim();
                            let address = cells.eq(1).text().trim();
                            let subject = cells.eq(2).text().trim();

                            // Create a new DOM row with a checkbox + data attributes
                            let customRow = $(`
    <div class="email-row">
        <input
            type="checkbox"
            class="email-checkbox"
            data-date="${messageDate}"
            data-address="${address}"
            data-subject="${subject}"
        />
        <span class="email-date">${messageDate}</span>
        <span class="email-address">${address}</span>
        <span class="email-subject">${subject}</span>
    </div>
`);


                            // Attach the change handler directly
                            customRow.find(".email-checkbox").on("change", function () {
                                if (this.checked) {
                                    let uploadButton = window.top.document.getElementById("uploadButtonTwo");
                                    uploadButton.style.display = "block";
                                    customRow.css({
                                        background: 'linear-gradient(135deg, rgba(50, 192, 240, 0.2), rgba(120, 103, 173, 0.2))',
                                        transform: 'scale(1.02)'
                                    });
                                } else {
                                    let uploadButton = window.top.document.getElementById("uploadButtonTwo");
                                    uploadButton.style.display = "none";
                                    customRow.css({
                                        background: '',
                                        transform: ''
                                    });
                                }
                            });
                            $("#emailsDiv").append(customRow);
                        });




                    } catch (ex) {
                        console.error("we have error", ex);
                    }
                },
                _createFolder: async function (name = null) {
                    /// e.preventDefault(); //prevent default everytime
                    let sitesDropdown = $("#sitesDropdown");
                    //let foldersDropdown = $("#foldersDropdown");
                    let folderName;
                    const customAttributeUrl = _fullPluginPathHandler + "?endpoint=CustomAttribute"; // adjust as needed

                    let namingConvention = await (await fetch(_fullPluginPathHandler + "?endpoint=createFolderOption")).text(); //now we can get naming convention from bafckend
                    console.log("naming convention is ", namingConvention);




                    //const customAttribute = await (await fetch(customAttributeUrl)).text();
                    let customAttribute = await Sharepoint._getAllCustomAttributeValue();

                    console.log("custom att is ", customAttribute);
                    if (customAttribute === null) {
                        customAttribute = "";
                    }

                    switch (namingConvention) { //set name based on the convention
                        case "MSM":
                            folderName = Sharepoint._requestAcronym + "-" + Sharepoint._requestNumber;
                            break
                        case "Custom Attribute":
                            folderName = customAttribute;
                            break
                        case "MSMAndCustomAttribute":
                            folderName = Sharepoint._requestAcronym + "-" + Sharepoint._requestNumber + "-" + customAttribute;
                            break
                    }
                    //let name = ""

                    console.log("we are getting here 2717");
                    if (name === null || name === "") {
                        console.log("please enter a name ");
                        //return;
                        //folderName = Sharepoint._requestAcronym + "-" + Sharepoint._requestNumber + "-" + customAttribute; //we will use .trim after to condense it
                        //} else {
                        //    folderName = name;
                        //}
                        name = folderName //if name is empty then we can set a default name


                    } 
                    console.log("name is ", folderName)

                    try {
                        //console.log("req id is", reqId, "identifier is ", this._rowIndex);
                        console.log(" we are calling get create folder now");
                        let reqId = MarvalSoftware.UI.Controls.ScriptManager.getInstance().getPage()._requestId;
                        console.log("req id is", reqId, "identifier is ", this._rowIndex);
                        console.log("creating folder with current path ", Sharepoint._currentPath);

                        //let name2 = Sharepoint._requestAcronym + "-" + Sharepoint._requestNumber + " " + customAttribute;


                        let url = this._getPluginPath() + "handler/APIHandler.ashx?endpoint=createFolder&reqId=" + reqId + "&identifier=" + this._rowIndex + "&attachmentName=" + name.trim() + "&ReqId " + reqId;
                        console.log("we are going to this create url ", url);
                        //console.log("site id is", sitesDropdown.val(), "folderid is", foldersDropdown.find("option:selected").text());

                        let payLoad = {
                            microsoftToken: Sharepoint._microsoftToken,
                            siteId: sitesDropdown.val(),
                            folderId: Sharepoint._currentPath//create here

                        }
                        console.log("url is", url);
                        const result = await fetch(url, {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json; charset=utf-8"
                            },
                            body: JSON.stringify(payLoad)
                        });
                        if (!result.ok) {
                            const errorText = await result.text();
                            throw new Error(`HTTP error ${result.status}: ${errorText}`);
                            $("#successMessage")
                                .text("Error did not create folder")
                                .fadeIn("slow")      // Fade in
                                .delay(2000)         // Wait 2 seconds
                                .fadeOut("slow");
                        }

                        $("#successMessage")
                            .text("Successfully created folder")
                            .fadeIn("slow")      // Fade in
                            .delay(2000)         // Wait 2 seconds
                            .fadeOut("slow");

                        const attachment = await result.json();
                        console.log("attachment feedback", attachment);
                        // Construct fake folder item (you may need to adjust these fields)
                        await Sharepoint._toggleFolder(Sharepoint._currentSelectedFolderId, {}, { preventDefault: () => { } }, true);
                        return attachment;


                    } catch (ex) {
                        $("#successMessage")
                            .text("error did not create folder")
                            .fadeIn("slow")      // Fade in
                            .delay(2000)         // Wait 2 seconds
                            .fadeOut("slow");
                        console.error("we have error", ex);
                    }

                }, _formatDate: function (dateString) {
                    if (!dateString) return '';
                    const date = new Date(dateString);
                    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                },

                _fetchChildren: async function (folderId) {
                    // Use the path from the map, which is set in _renderChildren
                    const folderPath = folderPaths[folderId] || "";
                    //console.log("folder id here fo")
                    console.log("the fetch children folder pth is ", folderPath, " with folder id ", folderId);

                    // Get the selected siteId
                    let siteId = window.top.document.getElementById('sitesDropdown').value;

                    // Call the real API
                    const foldersJson = await Sharepoint._getAllFolders(siteId, folderPath);
                    console.log("fetch children results are ", foldersJson);

                    // Only return folders
                    return {
                        value: (foldersJson && foldersJson.value)
                            ? foldersJson.value.filter(item => item.folder)
                            : []
                    };
                },

                _displaySelectedAttachments: function () {
                    let finalWindow = window.top.document.getElementById("ct100_overlay_id6");
                    let test = document.createElement("div");
                    test.innerText = "hi";
                    finalWindow.appendChild(test);

                    //let finalWindow = $("#ct100_overlay_id6");

                    //// Clear existing content
                    //finalWindow.empty();


                    //// let containerDiv = document.createElement("div");
                    //let containerDiv = $("<div></div>"); 

                    //// Create section containers
                    //let attachmentsSection = $("<div><h3>Attachments</h3></div>");
                    //let notesSection = $("<div><h3>Notes</h3></div>");
                    //let emailsSection = $("<div><h3>Emails</h3></div>");

                    //// Append checked attachments
                    //$("#attachmentsDiv input[type='checkbox']:checked").each(function () {
                    //    let name = $(this).val();
                    //    attachmentsSection.append(`<div>${name}</div>`);
                    //});

                    //// Append checked notes
                    //$("#notesDiv input[type='checkbox']:checked").each(function () {
                    //    let noteText = $(this)
                    //        .closest(".note2-item")
                    //        .find(".note2-summary")
                    //        .text()
                    //        .trim();
                    //    notesSection.append(`<div>${noteText}</div>`);
                    //});

                    //// Append checked emails
                    //$("#emailsDiv input[type='checkbox']:checked").each(function () {
                    //    let subject = $(this).data("subject");
                    //    emailsSection.append(`<div>${subject}</div>`);
                    //});

                    //containerDiv.append(attachmentsSection);
                    //containerDiv.append(notesSection);
                    //containerDiv.append(emailsSection);
                    //finalWindow.append(containerDiv);

                },


                //function createTreeItem(item, level = 0)
                _createTreeItem: function (item, level) {
                    //console.log("we are at create tree item");
                    const self = this;

                    const isExpanded = expandedFolders.has(item.id);
                    //console.log("is expanded is ", isExpanded)

                    const isLoading = loadingFolders.has(item.id);
                    //console.log("is loading is ", isLoading);

                    const itemElement = document.createElement('div');
                    itemElement.className = 'tree-item';
                    itemElement.style.paddingLeft = `${level * 20 + 8}px`;
                    itemElement.dataset.itemId = item.id;

                    //let customAttribute = await Sharepoint._getAllCustomAttributeValue();

                    //console.log("custom att is ", customAttribute);
                    //if (customAttribute === null) {
                    //    customAttribute = "";
                    //}

                    // Controls container
                    const controlsDiv = document.createElement('div');
                    controlsDiv.className = 'tree-controls';

                    if (isLoading) {
                        // Spinner
                        controlsDiv.innerHTML = icons.spinner;
                    } else {
                        // Expand/collapse button

                        let createBtn = document.createElement("button");
                        //createBtn.textContent = "+";
                        createBtn.innerHTML = icons.plus;
                        createBtn.classList.add("mini-create-btn");

                        createBtn.addEventListener("click", (e) => {
                            e.preventDefault();
                            e.stopPropagation();

                            let parentItem = e.currentTarget.parentElement.parentElement; // Get the tree-item div
                            let parentId = parentItem?.dataset.itemId;

                            //Sharepoint._SuggestDirectoryName = await(await fetch(_fullPluginPathHandler + "?endpoint=SuggestDirectoryName")).text();

                            // Only append if input doesn't already exist
                            if (!parentItem.querySelector(".new-folder-input")) {
                                let newDiv = document.createElement("div");
                                newDiv.classList.add("tree-item", "editing");
                                newDiv.style.paddingLeft = `${(level + 1) * 20 + 8}px`; // Indent one level deeper

                                let input = document.createElement("input");
                                input.classList.add("new-folder-input");
                                input.placeholder = "New Folder Name";

                                let suggestName = "";
                                if (Sharepoint._SuggestDirectoryName === "yes") {
                                    console.log("suggest name is yes")
                                    suggestName = Sharepoint._requestAcronym + "-" + Sharepoint._requestNumber + "-" + Sharepoint._customAttribute
                                } else {
                                    console.log("suggestr name is no")
                                    suggestName = "";
                                }
                                input.value = suggestName

                                let confirm = document.createElement("button");
                                confirm.textContent = "âœ”";
                                confirm.onclick = (event) => {
                                    event.preventDefault();
                                    let name = input.value.trim();
                                    if (name) {
                                        const newId = `folder_${Date.now()}`;
                                        const newFolder = {
                                            id: newId,
                                            name: name, // Use the actual input value
                                            parentId: parentId,
                                            children: [],
                                        };

                                        // Register it in the folder data structure
                                        if (!folderData[newId]) {
                                            folderData[newId] = newFolder; //ading to my hashmap with new details
                                        }

                                        // Add to parent's children array
                                        if (!folderData[parentId]) { //
                                            folderData[parentId] = { children: [] };
                                        }
                                        if (!folderData[parentId].children) {
                                            folderData[parentId].children = [];
                                        }
                                        folderData[parentId].children.push(newFolder); // Push the folder object, not just ID
                                        //add the create folder so _create folder for mine
                                        //make sure to update the path correctly as well, then we can re render the tree, do re togle folder thing after creation and ok]
                                        //if they leave it empty, the background should be the incident name + type + req id?
                                        //maybe need to delete those things in folder data

                                        //actually when we render childern, we cannot find this fake id when we fetch children so it wont get rednered anyways

                                        // Remove the input div
                                        newDiv.remove();
                                        //if (name === null) {
                                        //    name = "";
                                        //}
                                        //console.log("we are about to call create folde fun")
                                        //Sharepoint._createFolder(name);//should render as well, putting from input



                                    }//whenever tick is clicked then we do this
                                    if (name === null) {
                                        name = "";
                                    }
                                    console.log("we are about to call create folde fun")
                                    Sharepoint._createFolder(name);//should render as well, putting from input
                                };

                                let cancel = document.createElement("button");
                                cancel.textContent = "âœ–";
                                cancel.onclick = () => {
                                    newDiv.remove();
                                };

                                let folderElement = icons.folderClosed;
                                let folderSpan = document.createElement('span');
                                folderSpan.innerHTML = folderElement;

                                newDiv.appendChild(folderSpan);

                                newDiv.appendChild(input);
                                newDiv.appendChild(confirm);
                                newDiv.appendChild(cancel);

                                // Insert the new folder input right after the parent item
                                parentItem.insertAdjacentElement('afterend', newDiv);

                                // Focus the input
                                input.focus();
                            }
                        });

                        controlsDiv.appendChild(createBtn);



                        const expandBtn = document.createElement('button');
                        expandBtn.className = 'expand-button2';
                        expandBtn.innerHTML = icons.chevronRight;
                        if (isExpanded) {
                            expandBtn.querySelector('.chevron').classList.add('expanded');//tyr to add class this way
                        }
                        $(".expand-button2").on('click', function () {
                            console.log("clicked button")
                            $(this).closest('.folder-name').css("color", 'red');
                        })
                        expandBtn.addEventListener('click', (e) => {
                            e.preventDefault();
                            console.log("clicked button")
                            $(e).closest('.folder-name').css("color", "red");
                            self._toggleFolder(item.id, expandBtn, e);//toggle folder onclick
                        });
                        controlsDiv.appendChild(expandBtn);

                    }

                    // Folder icon
                    const folderIcon = document.createElement('span');
                    folderIcon.innerHTML = isExpanded ? icons.folderOpen : icons.folderClosed;
                    controlsDiv.appendChild(folderIcon);

                    // Compose the rest
                    const nameSpan = document.createElement('span');
                    nameSpan.className = 'folder-name';
                    nameSpan.textContent = item.name;

                    //const countHtml = item.folder && item.folder.childCount > 0 ?
                    //    `<span class="item-count">${item.folder.childCount} items</span>` : '';

                    //const dateHtml = `<span class="last-modified">${Sharepoint._formatDate(item.lastModifiedDateTime)}</span>`;

                    itemElement.appendChild(controlsDiv);
                    itemElement.appendChild(nameSpan);
                    //if (countHtml) itemElement.insertAdjacentHTML('beforeend', countHtml);
                    //itemElement.insertAdjacentHTML('beforeend', dateHtml);

                    // Hover effects
                    itemElement.addEventListener('mouseenter', () => itemElement.classList.add('hovered'));
                    itemElement.addEventListener('mouseleave', () => itemElement.classList.remove('hovered'));

                    // Add click handler to the whole tree item
                    itemElement.addEventListener('click', function (e) {
                        // Prevent double handling if the expand/collapse button was clicked
                        if (e.target.closest('.expand-button2')) return;

                        // Set current path and update UI
                        Sharepoint._prevId = Sharepoint._currentSelectedFolderId;
                        Sharepoint._currentSelectedFolderId = item.id;
                        Sharepoint._currentPath = folderPaths[item.id];

                        // Update the selected folder display
                        let text = "Current Selected Path is: " + Sharepoint._currentPath;
                        $("#selectedFolder").text(text);

                        // Optionally, update the selected style for the folder name
                        $('.folder-name').removeClass('selected');
                        nameSpan.classList.add('selected');
                    });

                    return itemElement;
                }, _collapseDescendants: function (folderId) {
                    expandedFolders.delete(folderId);
                    delete folderPaths[folderId];

                    const childrenContainer = window.top.document.querySelector(`[data-children-of="${folderId}"]`);
                    if (childrenContainer) {
                        const childFolderElements = childrenContainer.querySelectorAll('.tree-item');
                        childFolderElements.forEach(childEl => {
                            const childId = childEl.dataset.itemId;
                            if (expandedFolders.has(childId)) {
                                Sharepoint._collapseDescendants(childId);
                            }
                        });
                        childrenContainer.remove();
                    }
                },

                // Toggle folder expand/collapse
                _toggleFolder: async function (folderId, sender, e, forceRefresh = false) {
                    if (e?.preventDefault) e.preventDefault();

                    Sharepoint._prevId = this._currentSelectedFolderId;
                    Sharepoint._currentSelectedFolderId = folderId;
                    Sharepoint._currentPath = folderPaths[folderId];

                    let text = "Current Selected Path is: " + Sharepoint._currentPath;
                    $("#selectedFolder").text(text);

                    const selectedItem = $(`[data-item-id="${folderId}"] .folder-name`);
                    if (selectedItem.length) {
                        $('.folder-name').removeClass('selected');
                        selectedItem.addClass("selected").css("color", "red");
                    }

                    if (loadingFolders.has(folderId)) return;

                    const isExpanded = expandedFolders.has(folderId);

                    if (isExpanded && !forceRefresh) {
                        Sharepoint._collapseDescendants(folderId);
                        expandedFolders.delete(folderId);
                        Sharepoint._updateTreeItem(folderId);
                        return;
                    }

                    // Always re-fetch if forceRefresh is true
                    loadingFolders.add(folderId);
                    Sharepoint._updateTreeItem(folderId);

                    try {
                        if (forceRefresh || !folderData[folderId]) {
                            const response = await Sharepoint._fetchChildren(folderId);
                            folderData[folderId] = response.value;
                        }

                        // Remove previous child container if exists
                        const existingContainer = window.top.document.querySelector(`[data-children-of="${folderId}"]`);
                        if (existingContainer) existingContainer.remove();

                        expandedFolders.add(folderId);
                        Sharepoint._renderChildren(folderId);
                    } catch (error) {
                        console.error('Error fetching children:', error);
                        expandedFolders.delete(folderId);
                    } finally {
                        loadingFolders.delete(folderId);
                        Sharepoint._updateTreeItem(folderId);
                    }
                },


                _updateTreeItem: function (itemId) {
                    const itemElement = window.top.document.querySelector(`[data-item-id="${itemId}"]`);
                    if (!itemElement) {
                        console.log("No itemElement found for", itemId);
                        return;
                    }

                    const item = Sharepoint._findItemById(itemId);
                    if (!item) {
                        console.log("No item found for", itemId);
                        return;
                    }

                    const level = parseInt(itemElement.style.paddingLeft) / 20 - 0.4;
                    const newElement = Sharepoint._createTreeItem(item, level);

                    // Debug log
                    console.log("Replacing element for", itemId, "at level", level, "parent", itemElement.parentNode);

                    itemElement.parentNode.replaceChild(newElement, itemElement);
                },

                // Find item by ID in the data structure

                _findItemById: function (itemId) {
                    // Search root folders
                    for (const item of (folderData['root'] || [])) {
                        if (item.id === itemId) return item;
                    }
                    // Search all loaded children
                    for (const children of Object.values(folderData)) {
                        for (const item of children) {
                            if (item.id === itemId) return item;
                        }
                    }
                    return null;
                },

                // Render children of a folder
                _renderChildren: function (folderId) {
                    //console.log("we are rendering children now");
                    const children = folderData[folderId];
                    if (!children || children.length === 0) return;

                    const parentElement = window.top.document.querySelector(`[data-item-id="${folderId}"]`);
                    console.log("Parent element for", folderId, parentElement);
                    if (!parentElement) return;

                    // Remove existing children container
                    const existingContainer = window.top.document.querySelector(`[data-children-of="${folderId}"]`);
                    if (existingContainer) {
                        existingContainer.remove();
                    }

                    // Create new children container
                    const childrenContainer = document.createElement('div');
                    childrenContainer.className = 'children';
                    childrenContainer.dataset.childrenOf = folderId;

                    // Calculate level
                    const parentLevel = parseInt(parentElement.style.paddingLeft) / 20 - 0.4;
                    const childLevel = parentLevel + 1;

                    const parentPath = folderPaths[folderId] || "";



                    // Add child items
                    console.log("childeren is ", children)
                    children.forEach(child => {
                        folderPaths[child.id] = parentPath ? parentPath + "/" + child.name : child.name;
                        console.log("this childs path is ", folderPaths[child.id], " with id of ", child.id)

                        const childElement = Sharepoint._createTreeItem(child, childLevel);
                        childrenContainer.appendChild(childElement);
                    });

                    // Insert after parent
                    parentElement.insertAdjacentElement('afterend', childrenContainer);
                },

                _renderTree: async function () {
                    const container = window.top.document.getElementById('treeContent');
                    container.innerHTML = '';

                    Sharepoint._customAttribute = await Sharepoint._getAllCustomAttributeValue(); //setting it here

                    // Get the selected siteId from the dropdown
                    let siteId = window.top.document.getElementById('sitesDropdown').value;
                    if (!siteId) {
                        container.innerHTML = '<div>Please select a site.</div>';
                        return;
                    }

                    // Fetch folders from backend
                    console.log("we are calling with siteId ", siteId, " and folder path (should be null or empty for root):", null);
                    let foldersJson = await this._getAllFolders(siteId, null); //should be null here

                    if (foldersJson && foldersJson.value && Array.isArray(foldersJson.value)) {
                        // Only show items that are folders (have a .folder property)
                        folderData['root'] = foldersJson.value.filter(item => item.folder);//remember to add root folders to folder data

                        foldersJson.value
                            .filter(item => item.folder) // Only folders
                            .forEach(item => {
                                folderPaths[item.id] = item.name;//in initial render of tree we should set all paths first
                                const itemElement = Sharepoint._createTreeItem(item, 0);
                                container.appendChild(itemElement);
                            });
                    } else {
                        container.innerHTML = '<div>No folders found.</div>';
                    }
                },
                _renderAttachmentsWindow: function () {
                    let attachmentDiv = window.top.document.getElementById('attachmentsDiv');
                    let notesDiv = document.createElement("div");
                    notesDiv.innerText = "div 2";
                    let emailsDiv = document.createElement('div');
                    let $attachmentsDiv = $("#attachmentsDiv")
                    $attachmentsDiv.append("testingf1211");
                    $attachmentsDiv.append(notesDiv);
                    $attachmentsDiv.append(emailsDiv);
                    if (attachmentDiv) {
                        //attachmentDiv

                        //attachmentDiv.style.display = "block";
                        console.log("we found attachments div", attachmentDiv);
                    } else {
                        console.log("we cannot find attachments div")
                    }
                },
                

                // Initialize the tree
                //renderTree();

                // Make toggleFolder available globally
                //window.toggleFolder = toggleFolder;

                _popup: async function (eventTarget) {
                    console.log(eventTarget);
                    console.log(document.location.search);
                    let url = (new URLSearchParams(window.top.location.search)).get("id");
                    console.log(url);

                    let namingConvention = await (await fetch(_fullPluginPathHandler + "?endpoint=createFolderOption")).text(); //now we can get naming convention from bafckend
                    console.log("naming convention is ", namingConvention);

                    let url3 = _fullPluginPathHandler + "?endpoint=AutomateSubfolderCreation";
                    Sharepoint._AutomateSubfolderCreation = await(await fetch(_fullPluginPathHandler + "?endpoint=AutomateSubfolderCreation")).text();

                    Sharepoint._SuggestDirectoryName = await(await fetch(_fullPluginPathHandler + "?endpoint=SuggestDirectoryName")).text();

                    Sharepoint._createFolderOption = await(await fetch(_fullPluginPathHandler + "?endpoint=createFolderOption")).text();

                    let itemsDiv = document.createElement("div");
                    itemsDiv.id = "itemsDiv";
                    itemsDiv.className = "body";
                    itemsDiv.style.display = "block";


                    let FinalDiv = document.createElement("div");
                    FinalDiv.id = "FinalDiv";
                    FinalDiv.className = "body";
                    FinalDiv.style.display = "block";
                    FinalDiv.innerText = "hi this is the final div!";
                    let testDiv = document.createElement("div");
                    testDiv.innerText = "test div";
                    testDiv.id = "testDiv";

                    let finalUploadButton = document.createElement("button");
                    finalUploadButton.innerText = "upload final";
                    FinalDiv.appendChild(finalUploadButton);

                    FinalDiv.appendChild(testDiv);

                    function createSection(headerText, contentId) {
                        let section = document.createElement("div");
                        section.className = "section";

                        let sectionHeader = document.createElement("div");
                        sectionHeader.className = "section-header";
                        sectionHeader.style.display = "flex";
                        sectionHeader.style.alignItems = "center";
                        sectionHeader.style.justifyContent = "space-between";
                        sectionHeader.style.cursor = "pointer";

                        let headerTitle = document.createElement("span");
                        headerTitle.innerText = headerText;

                        let toggleButton = document.createElement("button");
                        toggleButton.className = "toggle-btn";
                        toggleButton.innerHTML = "â–¼"; // Down arrow when expanded
                        toggleButton.style.background = "none";
                        toggleButton.style.border = "none"; //we shouold probably style using a id then in the style section
                        toggleButton.style.fontSize = "12px";
                        toggleButton.style.cursor = "pointer";
                        toggleButton.style.padding = "2px 6px";
                        toggleButton.style.borderRadius = "3px";
                        toggleButton.style.transition = "transform 0.2s ease";

                        let sectionContent = document.createElement("div");
                        sectionContent.className = "section-content";
                        sectionContent.id = contentId;
                        sectionContent.style.transition = "all 0.3s ease";
                        sectionContent.style.overflow = "hidden";

                        // Toggle functionality
                        function toggleSection() {
                            const isCollapsed = sectionContent.style.display === "none";

                            if (isCollapsed) {
                                // Expand
                                sectionContent.style.display = "block"; //just hide and show
                                toggleButton.innerHTML = "â–¼";
                                toggleButton.style.transform = "rotate(0deg)";
                                sectionHeader.title = "Click to collapse";
                            } else {
                                // Collapse
                                sectionContent.style.display = "none"; //hide
                                toggleButton.innerHTML = "â–¶";
                                toggleButton.style.transform = "rotate(-90deg)";
                                sectionHeader.title = "Click to expand";
                            }
                        }

                        // Add click handlers
                        sectionHeader.addEventListener("click", toggleSection);
                        toggleButton.addEventListener("click", (e) => {
                            e.stopPropagation(); // Prevent double triggering
                            e.preventDefault();
                            toggleSection();
                        });

                        // Hover effects
                        sectionHeader.addEventListener("mouseenter", () => {
                            sectionHeader.style.backgroundColor = "#f0f0f0";
                        });
                        sectionHeader.addEventListener("mouseleave", () => {
                            sectionHeader.style.backgroundColor = "";
                        });

                        sectionHeader.appendChild(headerTitle);
                        sectionHeader.appendChild(toggleButton);
                        section.appendChild(sectionHeader);
                        section.appendChild(sectionContent);

                        return section;
                    }

                    // Create and append Notes section
                    let notesSection = createSection("ðŸ“ Notes", "notesDiv");
                    itemsDiv.appendChild(notesSection);

                    // Create and append Emails section
                    let emailsSection = createSection("ðŸ“§ Emails", "emailsDiv");
                    itemsDiv.appendChild(emailsSection);

                    // Create and append Attachments section
                    let attachmentsSection = createSection("ðŸ“Ž Attachments", "attachmentsDiv");
                    itemsDiv.appendChild(attachmentsSection);



                    // Combine Notes checkbox container
                    let combineNotesBox = document.createElement("div");
                    combineNotesBox.id = "combineNotesBox";
                    //combineNotesBox.style.marginTop = "10px";
                    combineNotesBox.style.width = "200px";

                    // Create the checkbox input
                    let combineCheckbox = document.createElement("input");
                    combineCheckbox.type = "checkbox";
                    combineCheckbox.id = "combineNotesCheckbox";
                    combineCheckbox.name = "combineNotes";

                    // Create a label for the checkbox
                    let combineLabel = document.createElement("label");
                    combineLabel.htmlFor = "combineNotesCheckbox";
                    combineLabel.innerText = "ðŸ§© Combine Notes";

                    // Append checkbox and label to the container div
                    combineNotesBox.appendChild(combineCheckbox);
                    combineNotesBox.appendChild(combineLabel);

                    // Append to the itemsDiv
                    itemsDiv.appendChild(combineNotesBox);
                    console.log("items div is ", itemsDiv);

                    

                    //let eventElement = eventTarget);
                    if (!this._pluginWindow) {
                        this._pluginWindow = new MarvalSoftware.UI.Window({
                            appendToElement: window.top.document.getElementById("aspnetForm"),
                            title: "Sharepoint",
                            height: 1000,
                            width: 1000,
                            minHeight: 700,
                            minWidth: 432,
                            isResizable: true,
                            isMaximizable: true,
                            bodyElement: this

                        }

                        );

                        //})
                        this._attachmentsWindow = new MarvalSoftware.UI.Window({
                            appendToElement: window.top.document.getElementById("aspnetForm"),
                            title: "Attachments",
                            height: 1000,
                            width: 1000,
                            minHeight: 300,
                            minWidth: 300,
                            isResizable: true,
                            isMaximizable: true,
                            bodyElement: itemsDiv,

                        }


                        );
                        this.finalWindow = new MarvalSoftware.UI.Window({
                            appendToElement: window.top.document.getElementById("aspnetForm"),
                            title: "Window",
                            height: 1000,
                            width: 1000,
                            minHeight: 300,
                            minWidth: 300,
                            isResizable: true,
                            isMaximizable: true,
                            bodyElement: FinalDiv,

                        });


                     //   console.log("directory window is ", directoryWindow)
                        this._renderElement();
                        //this._getAllAttachments();
                        //this._getAllNotes();
                        this._fetchSharePointSites();
                        //this._renderAttachmentsWindow();

                        if (eventTarget != undefined) {
                            console.log(eventTarget.parentElement.parentElement.nextSibling.innerText);
                        }
                    }
                    //this._resetPopUpValues();
                    if (!this._pluginWindow.isVisible()) {
                        this._pluginWindow.centerToViewport();
                    }

                    let self = this;
                    //likelyu hidden by default
                    this._pluginWindow.show();
                    this._attachmentsWindow.show();
                    this._attachmentsWindow.centerToViewport();
                    let uploadButtonTwo = document.createElement("button");
                    uploadButtonTwo.id = "uploadButtonTwo";
                    uploadButtonTwo.innerHTML = "ðŸš€ Upload all22";
                    uploadButtonTwo.onclick = function (e) {//when we click upload all
                        e.preventDefault();
                        console.log("current path is and we are calling prevenmt default ", Sharepoint._currentPath)
                        if (Sharepoint._currentPath === null || Sharepoint._currentPath === "") {
                            console.log("current pRTH IS NUbuefdueuhehuieihjeLL hi")
                            let directoryWindow = $("#ct100_overlay_id4");
                            directoryWindow.css("z-index", 1000000);
                            directoryWindow.show();
                            self._pluginWindow.centerToViewport();
                            console.log("should be displaying all attachments")
                            //Sharepoint._displaySelectedAttachments();
                            //this = window.top.document.getElementById("ct100_overlay_id5");
                            //console.log("this is ", this._attachmentsWindow);
                            self._attachmentsWindow._closeButtonElement_click();

                            
                        } else {
                            console.log("current paqth is not empty")

                            //Sharepoint._uploadAllAttachments(e);we can do this on the other window
                        }

                    };
                    itemsDiv.appendChild(uploadButtonTwo);
                    uploadButtonTwo.style.display = "none"; //hide it 
                    //this.finalWindow.render();
                   // this.finalWindow.centerToViewport();
                  //  this.finalWindow.show();
                    
                    //this.finalWindow.centerToViewport();
                    this._getAllEmails();

                    //setTimeout(200);
                    //this._renderAttachmentsWindow();
                    console.log("should be calling get all emails and notes etc")
                    this._getAllNotes();
                    this._getAllAttachments();
                    //this._displaySelectedAttachments();

                    let uploadButton = $('#saveButton');
                    if (uploadButton.length > 0) {
                        console.log("can find upload button")
                        uploadButton.on("click", function (e) {
                            console.log("clicking on button")
                            e.preventDefault();
                            //Sharepoint._appendSelectedItemsToFinalDiv();
                            //seems that we need to  render second window then open third window
                            self.finalWindow.render();
                            self.finalWindow.centerToViewport();
                            self.finalWindow.show();
                            Sharepoint._appendSelectedItemsToFinalDiv();
                            self._pluginWindow._closeButtonElement_click();
                        });
                    } else {
                        console.warn("#saveButton not found at the time of binding.");
                    }


                    
                    let directoryWindow = $("#ct100_overlay_id4");
                    let attachmentWindowButton = $("#AttachmentsPage");
                    attachmentWindowButton.on("click", function (e) {
                        console.log("we clicked onm attachment window button")
                        e.preventDefault();
                        self._attachmentsWindow.render();
                        self._attachmentsWindow.centerToViewport();
                        self._attachmentsWindow.show();
                    })

                    //let finalWindowStuff = $("<div><h3>final stgyuff</h3></div>");
                    //this.finalWindow.append(finalWindowStuff);

                    if (attachmentWindowButton.length > 0) {
                        attachmentWindowButton.click(function (e) {
                            e.preventDefault();
                            directoryWindow.hide();

                            let overlayWindow = $("#ct100_overlay_id5");
                            overlayWindow.css({
                                display: "block",
                                zIndex: 9999
                            });

                            // Force focus and bring to front
                            overlayWindow.focus();
                            overlayWindow.trigger("focus");

                            // Find first focusable element and focus it
                            let firstInput = overlayWindow.find('input, button, select, textarea').first();
                            if (firstInput.length > 0) {
                                firstInput.focus();
                            }
                        });
                    } else {
                        console.log("cannot find button");
                    }
                    //this._finalPopup();

                    $('.window .content .header').eq(0).addClass('headerColourChange');
                    $('.window .content .header').eq(1).addClass('LinkedProjectsHeader');
                    
                    directoryWindow.hide();
                },

                _errorPopup: function (result) {
                    var errorTemplate = document.querySelector('.errorTemplate').content;
                    var errorMessages = window.top.document.importNode(errorTemplate, true);
                    if (result) {
                        for (var item in result) {
                            var id = "#" + item;
                            errorMessages.querySelector(id).style.display = "block";
                        }
                        errorMessages.querySelector('div > h3').textContent = this._getString("@@SharepointErrorConfigurationTitle");
                        errorMessages.querySelector('div > h4').textContent = this._getString("@@SharepointErrorConfigurationFooter");
                    }
                    MarvalSoftware.UI.MessageBox.show(
                        this._getString("@@SharepointErrorPopupTitle"),
                        errorMessages,
                        MarvalSoftware.UI.MessageBox.Types.ERROR,
                        [MarvalSoftware.UI.MessageBox.Buttons.OK],
                        MarvalSoftware.UI.MessageBox.Buttons.OK,
                        450
                    );
                },

                _miscellaneousErrorPopup: function (result) {
                    var miscellaneousErrorsTemplate = document.querySelector('.miscellaneousErrorsTemplate').content;
                    var errorMessages = window.top.document.importNode(miscellaneousErrorsTemplate, true);
                    if (result) {
                        console.log("We have an error ", result);
                        errorMessages.querySelector('div > label').textContent = result.responseText;
                    }
                    MarvalSoftware.UI.MessageBox.show(
                        this._getString("@@SharepointErrorPopupTitle"),
                        errorMessages,
                        MarvalSoftware.UI.MessageBox.Types.ERROR,
                        [MarvalSoftware.UI.MessageBox.Buttons.OK],
                        MarvalSoftware.UI.MessageBox.Buttons.OK,
                        450
                    );
                },

                _addCard: function (results) {
                    this._clearCards();
                    if (!results.incident_updates || results.incident_updates.length == 0) {
                        var label = document.createElement("h3")
                        label.textContent = this._getString("@@SharepointNoItems");
                        label.align = "center";
                        label.style.position = "relative";
                        label.style.top = "150px";
                        label.style.color = "#808080";
                        this._cards.appendChild(label);
                        return;
                    }

                    for (var i = 0; i < results.incident_updates.length; i++) {
                        this._resetCard()
                        var status = results.incident_updates[i].status;
                        var createdOn = results.incident_updates[i].display_at;
                        this.timestamp.firstElementChild.innerHTML = new Date(createdOn).toDateString() + " " + this._formattedTime(createdOn);
                        this.timestamp.innerHTML += this._formattedDate(createdOn).toUpperCase();
                        this.status.innerText = status.charAt(0).toUpperCase() + status.slice(1);
                        this.message.innerText = results.incident_updates[i].body;
                        this._cards.appendChild(this.card);
                    }

                    this._cards.scrollTop = 0
                },

                _clearCards: function () {
                    while (this._cards.firstChild) {
                        this._cards.removeChild(this._cards.firstChild);
                    }
                },

                _resetCard: function () {
                    var cardTemplate = document.querySelector(".cardTemplate").content;
                    var element = window.top.document.importNode(cardTemplate, true);
                    this.card = element.querySelector(".card");
                    this.timestamp = element.querySelector(".card > .timestamp");
                    this.status = element.querySelector(".card > .status");
                    this.message = element.querySelector(".card > .message");
                },

                _refreshCards: function () {
                    this._getAllIncindentUpdates();
                    this._enableOrDisableIncidentsOption();
                },

                _resetPopUpValues: function () {
                    this._pages.selectedIndex = "0";
                    this._body.value = "";
                    this._clearIncidents();
                },

                _clearIncidents: function () {
                    for (var i = this._incidents.options.length - 1; i >= 0; i--) {
                        this._incidents.remove(i);
                    }

                    var incident = document.createElement("option")
                    incident.id = 0;
                    incident.value = "";
                    this._incidents.add(incident)
                    this._refreshCards();
                },

                _formattedDate: function (updatedBy) {
                    var minute = 60 * 1000;
                    var hour = minute * 60;
                    var day = hour * 24;
                    var month = day * 30;
                    var year = day * 365;
                    var elapsed = new Date().getTime() - new Date(updatedBy).getTime();
                    if (elapsed < minute) {
                        return "< 1 min ago";
                    }
                    else if (elapsed < hour) {
                        var calculatedHours = Math.round(elapsed / minute);
                        return calculatedHours > 1 ? calculatedHours + " minutes ago" : calculatedHours + " min ago";
                    }
                    else if (elapsed < day) {
                        var calculatedDays = Math.round(elapsed / hour);
                        return calculatedDays > 1 ? calculatedDays + " hours ago" : calculatedDays + " hour ago";
                    }
                    else if (elapsed < month) {
                        var calculatedMonths = Math.round(elapsed / day);
                        return calculatedMonths > 1 ? calculatedMonths + " days ago" : calculatedMonths + " day ago";
                    }
                    else if (elapsed < year) {
                        var calculatedMonths = Math.round(elapsed / month);
                        return calculatedMonths > 1 ? calculatedMonths + " months ago" : calculatedMonths + " month ago";
                    }
                    else {
                        var calculatedYears = Math.round(elapsed / year);
                        return calculatedYears > 1 ? calculatedYears + " years ago" : calculatedYears + " year ago";
                    }
                },

                _addZero: function (i) {
                    if (i < 10) {
                        i = "0" + i;
                    }
                    return i;
                },

                _formattedTime: function (value) {
                    var date = new Date(value);
                    return this._addZero(date.getHours()) + ":" + this._addZero(date.getMinutes());
                },

                _setUpQuickMenu: function () {
                    var styleElement = window.top.document.createElement("style");
                    window.top.document.body.appendChild(styleElement);
                    styleElement.sheet.insertRule(".marvalSoftware-sharepoint-quick-menu-item { background-image: url(" + this._getPluginPath() + "img/sharepoint_32.png); }", 0);

                    var quickMenuId = window.top.document.querySelector(".quickMenu").id;
                    var quickMenu = MarvalSoftware.UI.Controls.ScriptManager.getInstance().getControl(quickMenuId);
                    quickMenu.addMenuItem({
                        Identifier: "marvalSoftware-sharepoint",
                        Label: this._getString("@@PluginDisplayname"),
                        HRef: "javascript:void(0);",
                        CssClass: "marvalSoftware-sharepoint-quick-menu-item"
                    });
                    quickMenu.onMenuItemClicked.subscribe(function (sender, e) {
                        if (e.menuItem.getIdentifier() === "marvalSoftware-sharepoint") {
                            //window.open("", "_blank", "width=800,height=600")
                            this._popup();
                        }
                    },
                        this);
                },

                _preRequisiteCheck: function (sender, e) {

                    $.ajax({
                        type: "POST",
                        url: this._getPluginPath() + "handler/ApiHandler.ashx?action=PreRequisiteCheck",
                        contentType: "application/json; charset=utf-8",
                        dataType: "json",
                        success: function (result) {
                            if (Object.keys(result).length > 0) {
                                this._errorPopup(result);
                            }
                            else {
                                this._popup();
                            }
                        }.bind(this)
                    });
                }, _postMessage: function (sender, e) {
                    e.preventDefault();
                    var messageText = $('#message').val();
                    let email = this._contactEmail ? this._contactEmail : " No email defined";
                    let description = window.top.document.getElementById("ctl00_cph_description").value;
                    var payload = {};
                    //if (window.top.document.getElementById("CheckBox").checked) {
                    //    var formulatedMessage = messageText + " under request number: " + this._requestNumber + ", request ID: " + this._requestID + ", the request description: " + description + ", from :" + email;
                    //    payload = {
                    //        message: formulatedMessage,
                    //        action: "SendSharepointMessage"
                    //    }
                    //} else {//not checked
                    //    payload = {
                    //        message: messageText,
                    //        action: "SendSharepointMessage"
                    //    }
                    //}
                    console.log("We are here");



                    $.ajax({
                        type: "POST",
                        url: this._getPluginPath() + "handler/ApiHandler.ashx?action=SendSharepointMessage",
                        contentType: "application/json; charset=utf-8",
                        dataType: "json",
                        data: JSON.stringify(payload),
                        success: function (result) {
                            if (Object.keys(result).length > 0) {
                                this._errorPopup(result);
                            }
                            else {
                                //this._popup();
                            }
                        }.bind(this)
                    });
                },


                _getAllPageIncindents: function () {
                    $.ajax({
                        type: "POST",
                        url: this._getPluginPath() + "handler/ApiHandler.ashx?action=GetAllPageIncidents&pageId=" + this._pages.options[this._pages.selectedIndex].value,
                        contentType: "application/json; charset=utf-8",
                        dataType: "json",
                        success: function (results) {
                            if (results) {
                                this._clearIncidents();
                                for (var i = 0; i < results.length; i++) {
                                    var incident = document.createElement("option");
                                    incident.value = results[i].id;
                                    incident.text = results[i].name;
                                    this._incidents.add(incident);
                                }
                            }
                        }.bind(this),
                        error: function (results) {
                            this._clearIncidents();
                        }.bind(this)
                    });
                },

                /** */

                _getAllFolders: async function (siteId, folderPath = null) {
                    //Sharepoint._getAuth();
                    console.log("we are calling GETALLFOLDERS");
                    let apptoken = Sharepoint._microsoftToken;
                    if (folderPath) {
                        console.log("folder path in get all folders ", folderPath);
                    } else {
                        console.log("folder path is still null")
                    }

                    try {

                        const response = await fetch(_fullPluginPathHandler + "?endpoint=getAllFolders", {
                            method: "POST",
                            "headers": [["content-type", "application/json"]],
                            body: JSON.stringify({
                                "apptoken": apptoken,
                                "siteId": siteId,
                                "folderPath": folderPath
                            })
                            // headers:{'apptoken':apptoken}

                        });
                        let foldersJson = await response.json(); //response promise

                        console.log("All folders are: ", foldersJson);

                        console.log("appending should finish!");

                        //in theory should have all our sites if response is correct
                        return foldersJson;//so we can use it later


                    } catch (error) {
                        console.log("Error fetching sites: ", error);
                    }
                },
                _getAllCustomAttributeValue: async function () {
                    let reqId = MarvalSoftware.UI.Controls.ScriptManager.getInstance().getPage()._requestId;
                    let url = _fullPluginPathHandler + "?endpoint=getCustomAttributeValues&reqId=" + reqId;
                    try {

                        const response = await fetch(url, {
                            method: "GET",
                            "headers": [["content-type", "application/json"]],


                        });
                        let CAJson = await response.json(); //response promise
                        console.log("ca json is ", CAJson);
                        const customAttributeUrl = _fullPluginPathHandler + "?endpoint=CustomAttribute"; // adjust as needed

                        const customAttribute = await (await fetch(customAttributeUrl)).text(); //now we need to match this
                        console.log("custom attribute json is ", customAttribute);

                        let returnVal = "";
                        CAJson.entity.data.attributes.forEach((attribute) => {
                            if (attribute.attributeType.name === customAttribute) {
                                returnVal = attribute.value//now we can use it to set folder name
                            }
                        })

                        console.log("All CA json are: ", CAJson);
                        return returnVal;

                        //in theory should have all our sites if response is correct
                        //return foldersJson;//so we can use it later


                    } catch (error) {
                        console.log("Error fetching custom attribute values: ", error);
                    }
                },
                _printSiteId: function (e) {
                    console.log("site id ", e.value);
                },

                _getAllIncindentUpdates: function () {
                    var pageId = this._pages.options[this._pages.selectedIndex].value;
                    var incidentNumber = this._incidents.options[this._incidents.selectedIndex].value;
                    this._showSpinner();
                    if (incidentNumber) {
                        $.ajax({
                            type: "POST",
                            url: this._getPluginPath() + "handler/ApiHandler.ashx?action=GetAllIncidentUpdates&pageId=" + pageId + "&incidentNumber=" + incidentNumber,
                            contentType: "application/json; charset=utf-8",
                            dataType: "json",
                            success: function (results) {
                                if (results) {
                                    this._addCard(results);
                                }
                            }.bind(this),
                            error: function (result) {
                                if (result) {
                                    this._addCard(result);
                                }
                            }.bind(this)
                        });
                    }
                    this._enableOrDisableMessageTextArea();
                    this._hideSpinner();

                },
                _createNewFolder(parentId) {
                    const newId = `folder_${Date.now()}`;
                    const newFolder = {
                        id: newId,
                        name: 'New Folder',
                        parentId: parentId,
                        children: [],
                    };

                    // Register it in your folder data structure
                    this.folderData[newId] = newFolder;

                    // Add to parent
                    if (!this.folderData[parentId].children) this.folderData[parentId].children = [];
                    this.folderData[parentId].children.push(newId);

                    // Mark parent expanded
                    this.folderData[parentId].expanded = true;

                    // Optional: track editing state
                    this.editingFolder = newId;
                    this.editingName = newFolder.name;

                    // Re-render
                    this.render();

                    // Focus the new input
                    setTimeout(() => {
                        const input = document.querySelector(`[data-folder-id="${newId}"] input`);
                        if (input) {
                            input.focus();
                            input.select();
                        }
                    }, 0);
                },


                _getAllPages: function (sender, e) {
                    $.ajax({
                        type: "POST",
                        url: this._getPluginPath() + "handler/ApiHandler.ashx?action=GetAllPages",
                        contentType: "application/json; charset=utf-8",
                        dataType: "json",
                        success: function (results) {
                            if (results) {
                                for (var i = 0; i < results.length; i++) {
                                    var page = document.createElement("option");
                                    page.value = results[i].id;
                                    page.text = results[i].name;
                                    this._pages.add(page);
                                }
                            }
                        }.bind(this)
                    });
                },
                _finalPopup: function () {
                    console.log("final popup should be caled")
                    document.addEventListener('DOMContentLoaded', function () {

                        this.finalWindow = new MarvalSoftware.UI.Window({
                            appendToElement: window.top.document.getElementById("aspnetForm"),
                            title: "Attachments",
                            height: 1000,
                            width: 1000,
                            minHeight: 300,
                            minWidth: 300,
                            isResizable: true,
                            isMaximizable: true,
                            bodyElement: itemsDiv
                        }); // âœ… fixed: closed the object + constructor call

                        this._renderElement();
                        //this._fetchSharePointSites();
                        // this._renderAttachmentsWindow();

                        //if (eventTarget != undefined) {
                        //    console.log(eventTarget.parentElement.parentElement.nextSibling.innerText);
                        //}
                        this._attachmentsWindow.centerToViewport();
                    }.bind(this)); // âœ… Important: bind `this` so it works inside DOMContentLoaded
                },


                _update: function (value) {
                    this._sendInProgress = true;
                    this._enableOrDisableSubmit();//as send is in progress, we need to disable the button

                    var data = { incident: { body: value } };
                    var pageId = this._pages.options[this._pages.selectedIndex].value;
                    var incidentNumber = this._incidents.options[this._incidents.selectedIndex].value;


                    $.ajax({
                        type: "POST",
                        url: this._getPluginPath() + "handler/ApiHandler.ashx?action=UpdateSharepointIncident&pageId=" + pageId + "&incidentNumber=" + incidentNumber,
                        contentType: "application/json; charset=utf-8",
                        dataType: "json",
                        data: JSON.stringify(data),
                        success: function (result, textStatus, xhr) {


                            if (result.error) {
                                this._miscellaneousErrorPopup({ "responseText": xhr.status + " " + result.error.join(", ") });
                            } else {
                                this._getAllIncindentUpdates();
                                this._body.value = "";
                            }
                            this._sendInProgress = false;
                            this._enableOrDisableSubmit();
                            sendBtn.disabled = false;

                        }.bind(this),
                        error: function (xhr) {

                            let statusCode = xhr.status;
                            let message = xhr.responseText;

                            try {
                                var parsed = JSON.parse(message);
                                if (parsed.error && Array.isArray(parsed.error)) {
                                    message = parsed.error.join(", ")
                                }
                            } catch (e) {

                            }
                            this._miscellaneousErrorPopup({
                                "responseText": statusCode + " " + message
                            })
                            this._sendInProgress = false;
                            this._enableOrDisableSubmit();
                            sendBtn.disabled = false;

                        }.bind(this)
                    });
                },


                _enableOrDisableIncidentsOption: function (sender, e) {
                    if (this._pages.selectedIndex > 0) {
                        this._incidents.removeAttribute('disabled');
                    } else {
                        this._incidents.setAttribute('disabled', '');
                    }
                },


                _enableOrDisableMessageTextArea: function (sender, e) {
                    if (this._pages.selectedIndex > 0 && this._incidents.selectedIndex > 0) {
                        this._body.removeAttribute('disabled');
                    } else {
                        this._body.setAttribute('disabled', '');
                    }
                }
            });
    })();
</script>
